<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>TIL: using Sphinx substitutions to generate text snippets from code | bylr.info</title>
<meta name=keywords content="python,sphinx,til">
<meta name=description content="Often, technical documentations include lists or other snippets of text that are strongly related to some of the project&rsquo;s code. vpype&rsquo;s documentation is no exception to this.
For instance, the Built-in symbols section lists the units available to expressions:
These units are related to the following piece of code:
# vpype/utils.py UNITS = { &#34;px&#34;: 1.0, &#34;in&#34;: 96.0, &#34;inch&#34;: 96.0, &#34;ft&#34;: 12.0 * 96.0, &#34;yd&#34;: 36.0 * 96.0, &#34;mi&#34;: 1760.0 * 36.">
<meta name=author content>
<link rel=canonical href=https://bylr.info/articles/2022/09/30/til-sphinx-substitutions/>
<link crossorigin=anonymous href=/assets/css/stylesheet.9d062edb236f2ea4fdd741bf42f29e31efa12bcd7050f0de6428570bde275986.css integrity="sha256-nQYu2yNvLqT910G/QvKeMe+hK81wUPDeZChXC94nWYY=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://bylr.info/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://bylr.info/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://bylr.info/favicon-32x32.png>
<link rel=apple-touch-icon href=https://bylr.info/apple-touch-icon.png>
<link rel=mask-icon href=https://bylr.info/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
</noscript><script defer data-domain=bylr.info data-api=https://sta.abeyeler.workers.dev/sta/event src=https://sta.abeyeler.workers.dev/sta/script.js></script><meta property="og:title" content="TIL: using Sphinx substitutions to generate text snippets from code">
<meta property="og:description" content="Often, technical documentations include lists or other snippets of text that are strongly related to some of the project&rsquo;s code. vpype&rsquo;s documentation is no exception to this.
For instance, the Built-in symbols section lists the units available to expressions:
These units are related to the following piece of code:
# vpype/utils.py UNITS = { &#34;px&#34;: 1.0, &#34;in&#34;: 96.0, &#34;inch&#34;: 96.0, &#34;ft&#34;: 12.0 * 96.0, &#34;yd&#34;: 36.0 * 96.0, &#34;mi&#34;: 1760.0 * 36.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://bylr.info/articles/2022/09/30/til-sphinx-substitutions/"><meta property="og:image" content="https://bylr.info/android-chrome-512x512.png"><meta property="article:section" content="articles">
<meta property="article:published_time" content="2022-09-30T00:00:00+00:00">
<meta property="article:modified_time" content="2022-09-30T00:00:00+00:00"><meta property="og:site_name" content="Antoine Beyeler">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://bylr.info/android-chrome-512x512.png">
<meta name=twitter:title content="TIL: using Sphinx substitutions to generate text snippets from code">
<meta name=twitter:description content="Often, technical documentations include lists or other snippets of text that are strongly related to some of the project&rsquo;s code. vpype&rsquo;s documentation is no exception to this.
For instance, the Built-in symbols section lists the units available to expressions:
These units are related to the following piece of code:
# vpype/utils.py UNITS = { &#34;px&#34;: 1.0, &#34;in&#34;: 96.0, &#34;inch&#34;: 96.0, &#34;ft&#34;: 12.0 * 96.0, &#34;yd&#34;: 36.0 * 96.0, &#34;mi&#34;: 1760.0 * 36.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Articles","item":"https://bylr.info/articles/"},{"@type":"ListItem","position":2,"name":"TIL: using Sphinx substitutions to generate text snippets from code","item":"https://bylr.info/articles/2022/09/30/til-sphinx-substitutions/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"TIL: using Sphinx substitutions to generate text snippets from code","name":"TIL: using Sphinx substitutions to generate text snippets from code","description":"Often, technical documentations include lists or other snippets of text that are strongly related to some of the project\u0026rsquo;s code. vpype\u0026rsquo;s documentation is no exception to this.\nFor instance, the Built-in symbols section lists the units available to expressions:\nThese units are related to the following piece of code:\n# vpype/utils.py UNITS = { \u0026#34;px\u0026#34;: 1.0, \u0026#34;in\u0026#34;: 96.0, \u0026#34;inch\u0026#34;: 96.0, \u0026#34;ft\u0026#34;: 12.0 * 96.0, \u0026#34;yd\u0026#34;: 36.0 * 96.0, \u0026#34;mi\u0026#34;: 1760.0 * 36.","keywords":["python","sphinx","til"],"articleBody":"Often, technical documentations include lists or other snippets of text that are strongly related to some of the project’s code. vpype’s documentation is no exception to this.\nFor instance, the Built-in symbols section lists the units available to expressions:\nThese units are related to the following piece of code:\n# vpype/utils.py UNITS = { \"px\": 1.0, \"in\": 96.0, \"inch\": 96.0, \"ft\": 12.0 * 96.0, \"yd\": 36.0 * 96.0, \"mi\": 1760.0 * 36.0 * 96.0, \"mm\": 96.0 / 25.4, \"cm\": 96.0 / 2.54, \"m\": 100.0 * 96.0 / 2.54, \"km\": 100_000.0 * 96.0 / 2.54, \"pc\": 16.0, \"pt\": 96.0 / 72.0, } I recently added support for more units and, of course, the documentation was at risk of running out of sync. Obviously, generating the list of units based on the code would be a better solution. After some Googling, here is how I did it.\nThe basic idea is to use substitutions. A substitution consists of assigning a text snippet to a keyword, and subsequently use said keyword (with the |keyword| syntax) in the documentation’s body. The second insight is to use the rst_prolog variable (within the conf.py file) for the definition. This being regular Python, the definition can easily be auto-generated based on the original code.\nHere is how it looks for the case above:\n# docs/conf.py import vpype as vp # [...] UNIT_STRINGS = \", \".join(f\"``{s}``\" for s in sorted(vp.UNITS.keys()) if s != \"in\") rst_prolog = f\"\"\" .. |units| replace:: {UNIT_STRINGS}\"\"\" (Note that in is explicitly excluded from the list because it is a reserved Python keyword and cannot be used in the context of vpype expressions.)\nAnd this is how the substitution is used in the actual documentation file:\n.. docs/fundamentals.rst * Units constants (|units|). These variables may be used to convert values to CSS pixels unit, which *vpype* uses internally. For example, the expression ``%(3+4)*cm%`` evaluates to the pixel equivalent of 7 centimeters (e.g. ~264.6 pixels). (Note that expressions may overwrite these variables, e.g. to use the ``m`` variable for another purpose.)Et voilà! Nice and easy. I certainly expect to use this technique often in the future.\n","wordCount":"351","inLanguage":"en","datePublished":"2022-09-30T00:00:00Z","dateModified":"2022-09-30T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://bylr.info/articles/2022/09/30/til-sphinx-substitutions/"},"publisher":{"@type":"Organization","name":"bylr.info","logo":{"@type":"ImageObject","url":"https://bylr.info/favicon.ico"}}}</script>
</head>
<body id=top>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://bylr.info/ accesskey=h title="bylr.info (Alt + H)">bylr.info</a>
<div class=logo-switches>
</div>
</div>
<ul id=menu>
<li>
<a href=https://bylr.info/about/ title=about>
<span>about</span>
</a>
</li>
<li>
<a href=https://bylr.info/archives title=archives>
<span>archives</span>
</a>
</li>
<li>
<a href=https://bylr.info/tags/ title=tags>
<span>tags</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
TIL: using Sphinx substitutions to generate text snippets from code
</h1>
<div class=post-meta><span title="2022-09-30 00:00:00 +0000 UTC">September 30, 2022</span>&nbsp;|&nbsp;<a href=https://github.com/abey79/abey79.github.io/blob/main/content/articles/til-sphinx-substitutions.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header>
<div class=post-content><p>Often, technical documentations include lists or other snippets of text that are strongly related to some of the project&rsquo;s code. <a href=https://github.com/abey79/vpype><em>vpype</em></a>&rsquo;s <a href=https://vpype.readthedocs.io/>documentation</a> is no exception to this.</p>
<p>For instance, the <a href=https://vpype.readthedocs.io/en/latest/fundamentals.html#built-in-symbols>Built-in symbols</a> section lists the units available to expressions:</p>
<img src=/til-sphinx-substitutions/doc_units.png alt="partial screenshot of vpype's documentation showing a list of units related to code" width=95% style=display:block;margin-left:auto;margin-right:auto>
<p>These units are related to the following piece of code:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#998;font-style:italic># vpype/utils.py</span>

UNITS <span style=color:#000;font-weight:700>=</span> {
    <span style=color:#d14>&#34;px&#34;</span>: <span style=color:#099>1.0</span>,
    <span style=color:#d14>&#34;in&#34;</span>: <span style=color:#099>96.0</span>,
    <span style=color:#d14>&#34;inch&#34;</span>: <span style=color:#099>96.0</span>,
    <span style=color:#d14>&#34;ft&#34;</span>: <span style=color:#099>12.0</span> <span style=color:#000;font-weight:700>*</span> <span style=color:#099>96.0</span>,
    <span style=color:#d14>&#34;yd&#34;</span>: <span style=color:#099>36.0</span> <span style=color:#000;font-weight:700>*</span> <span style=color:#099>96.0</span>,
    <span style=color:#d14>&#34;mi&#34;</span>: <span style=color:#099>1760.0</span> <span style=color:#000;font-weight:700>*</span> <span style=color:#099>36.0</span> <span style=color:#000;font-weight:700>*</span> <span style=color:#099>96.0</span>,
    <span style=color:#d14>&#34;mm&#34;</span>: <span style=color:#099>96.0</span> <span style=color:#000;font-weight:700>/</span> <span style=color:#099>25.4</span>,
    <span style=color:#d14>&#34;cm&#34;</span>: <span style=color:#099>96.0</span> <span style=color:#000;font-weight:700>/</span> <span style=color:#099>2.54</span>,
    <span style=color:#d14>&#34;m&#34;</span>: <span style=color:#099>100.0</span> <span style=color:#000;font-weight:700>*</span> <span style=color:#099>96.0</span> <span style=color:#000;font-weight:700>/</span> <span style=color:#099>2.54</span>,
    <span style=color:#d14>&#34;km&#34;</span>: <span style=color:#099>100_000.0</span> <span style=color:#000;font-weight:700>*</span> <span style=color:#099>96.0</span> <span style=color:#000;font-weight:700>/</span> <span style=color:#099>2.54</span>,
    <span style=color:#d14>&#34;pc&#34;</span>: <span style=color:#099>16.0</span>,
    <span style=color:#d14>&#34;pt&#34;</span>: <span style=color:#099>96.0</span> <span style=color:#000;font-weight:700>/</span> <span style=color:#099>72.0</span>,
}
</code></pre></div><p>I recently added <a href=https://github.com/abey79/vpype/pull/541>support for more units</a> and, of course, the documentation was at risk of running out of sync. Obviously, generating the list of units based on the code would be a better solution. After some Googling, here is how I did it.</p>
<p>The basic idea is to use <a href=https://www.sphinx-doc.org/en/master/usage/restructuredtext/basics.html#substitutions>substitutions</a>. A substitution consists of assigning a text snippet to a keyword, and subsequently use said keyword (with the <code>|keyword|</code> syntax) in the documentation&rsquo;s body. The second insight is to use the <code>rst_prolog</code> variable (within the <code>conf.py</code> file) for the definition. This being regular Python, the definition can easily be auto-generated based on the original code.</p>
<p>Here is how it looks for the case above:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#998;font-style:italic># docs/conf.py</span>

<span style=color:#000;font-weight:700>import</span> <span style=color:#555>vpype</span> <span style=color:#000;font-weight:700>as</span> <span style=color:#555>vp</span>

<span style=color:#998;font-style:italic># [...]</span>

UNIT_STRINGS <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;, &#34;</span><span style=color:#000;font-weight:700>.</span>join(<span style=color:#d14>f</span><span style=color:#d14>&#34;``</span><span style=color:#d14>{</span>s<span style=color:#d14>}</span><span style=color:#d14>``&#34;</span> <span style=color:#000;font-weight:700>for</span> s <span style=color:#000;font-weight:700>in</span> <span style=color:#0086b3>sorted</span>(vp<span style=color:#000;font-weight:700>.</span>UNITS<span style=color:#000;font-weight:700>.</span>keys()) <span style=color:#000;font-weight:700>if</span> s <span style=color:#000;font-weight:700>!=</span> <span style=color:#d14>&#34;in&#34;</span>)

rst_prolog <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>f</span><span style=color:#d14>&#34;&#34;&#34;
</span><span style=color:#d14>.. |units| replace:: </span><span style=color:#d14>{</span>UNIT_STRINGS<span style=color:#d14>}</span><span style=color:#d14>
</span><span style=color:#d14>&#34;&#34;&#34;</span>
</code></pre></div><p>(Note that <code>in</code> is explicitly excluded from the list because it is a reserved Python keyword and cannot be used in the context of <em>vpype</em> expressions.)</p>
<p>And this is how the substitution is used in the actual documentation file:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rst data-lang=rst><span style=color:#999;font-weight:700;font-style:italic>..
</span><span style=color:#999;font-weight:700;font-style:italic>  docs/fundamentals.rst
</span><span style=color:#999;font-weight:700;font-style:italic>
</span><span style=color:#999;font-weight:700;font-style:italic></span><span style=color:#099>*</span> Units constants (|units|).<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>  These variables may be used to convert values to CSS pixels unit, which <span style=color:#000;font-style:italic>*vpype*</span> uses internally. For example, the expression <span style=color:#d14>``%(3+4)*cm%``</span> evaluates to the pixel equivalent of 7 centimeters (e.g. ~264.6 pixels). (Note that expressions may overwrite these variables, e.g. to use the <span style=color:#d14>``m``</span> variable for another purpose.)<span style=color:#a61717;background-color:#e3d2d2>
</span></code></pre></div><p><em>Et voilà!</em> Nice and easy. I certainly expect to use this technique often in the future.</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://bylr.info/tags/python/>python</a></li>
<li><a href=https://bylr.info/tags/sphinx/>sphinx</a></li>
<li><a href=https://bylr.info/tags/til/>til</a></li>
</ul>
</footer><script src=https://utteranc.es/client.js repo=abey79/abey79.github.io issue-term=pathname label=comments theme=github-light crossorigin=anonymous async></script>
</article>
</main>
<footer class=footer>
<span>© 2022 Antoine Beyeler –</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='copy';function d(){a.innerHTML='copied!',setTimeout(()=>{a.innerHTML='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>