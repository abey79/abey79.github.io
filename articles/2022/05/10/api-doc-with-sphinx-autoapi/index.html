<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Generating beautiful Python API documentation with Sphinx AutoAPI | bylr.info</title>
<meta name=keywords content="python,sphinx">
<meta name=description content="Following a recent discussion on Twitter, I decided to take yet another deep dive in my Python projects' documentation and fix once and for all the issues I had with it. I first focused on the automatically-generated API reference section and this article details the results of my finding. Specifically, I&rsquo;m using vsketch&rsquo;s API reference, which I recently updated, as an example (documentation source.
This article addresses the following objectives:">
<meta name=author content>
<link rel=canonical href=https://bylr.info/articles/2022/05/10/api-doc-with-sphinx-autoapi/>
<meta name=google-site-verification content="XYZabc">
<link crossorigin=anonymous href=/assets/css/stylesheet.min.3108b1d460257d86252ac6b3389583463ded6d24c8d0cac98e612217cde39d76.css integrity="sha256-MQix1GAlfYYlKsazOJWDRj3tbSTI0MrJjmEiF83jnXY=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://bylr.info/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://bylr.info/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://bylr.info/favicon-32x32.png>
<link rel=apple-touch-icon href=https://bylr.info/apple-touch-icon.png>
<link rel=mask-icon href=https://bylr.info/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.91.2">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
</noscript>
<script defer data-domain=bylr.info data-api=https://sta.abeyeler.workers.dev/sta/event src=https://sta.abeyeler.workers.dev/sta/script.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-D1H30VS7VK"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-D1H30VS7VK',{anonymize_ip:!1})}</script>
<meta property="og:title" content="Generating beautiful Python API documentation with Sphinx AutoAPI">
<meta property="og:description" content="Following a recent discussion on Twitter, I decided to take yet another deep dive in my Python projects' documentation and fix once and for all the issues I had with it. I first focused on the automatically-generated API reference section and this article details the results of my finding. Specifically, I&rsquo;m using vsketch&rsquo;s API reference, which I recently updated, as an example (documentation source.
This article addresses the following objectives:">
<meta property="og:type" content="article">
<meta property="og:url" content="https://bylr.info/articles/2022/05/10/api-doc-with-sphinx-autoapi/">
<meta property="og:image" content="https://bylr.info/sphinx-autoapi/banner.png"><meta property="article:section" content="articles">
<meta property="article:published_time" content="2022-05-10T00:00:00+00:00">
<meta property="article:modified_time" content="2022-05-11T00:00:00+00:00"><meta property="og:site_name" content="Antoine Beyeler">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://bylr.info/sphinx-autoapi/banner.png">
<meta name=twitter:title content="Generating beautiful Python API documentation with Sphinx AutoAPI">
<meta name=twitter:description content="Following a recent discussion on Twitter, I decided to take yet another deep dive in my Python projects' documentation and fix once and for all the issues I had with it. I first focused on the automatically-generated API reference section and this article details the results of my finding. Specifically, I&rsquo;m using vsketch&rsquo;s API reference, which I recently updated, as an example (documentation source.
This article addresses the following objectives:">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Articles","item":"https://bylr.info/articles/"},{"@type":"ListItem","position":2,"name":"Generating beautiful Python API documentation with Sphinx AutoAPI","item":"https://bylr.info/articles/2022/05/10/api-doc-with-sphinx-autoapi/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Generating beautiful Python API documentation with Sphinx AutoAPI","name":"Generating beautiful Python API documentation with Sphinx AutoAPI","description":"Following a recent discussion on Twitter, I decided to take yet another deep dive in my Python projects' documentation and fix once and for all the issues I had with it. I first focused on the automatically-generated API reference section and this article details the results of my finding. Specifically, I\u0026rsquo;m using vsketch\u0026rsquo;s API reference, which I recently updated, as an example (documentation source.\nThis article addresses the following objectives:","keywords":["python","sphinx"],"articleBody":"Following a recent discussion on Twitter, I decided to take yet another deep dive in my Python projects' documentation and fix once and for all the issues I had with it. I first focused on the automatically-generated API reference section and this article details the results of my finding. Specifically, I‚Äôm using vsketch‚Äôs API reference, which I recently updated, as an example (documentation source.\nThis article addresses the following objectives:\n Produce a beautiful API documentation based on the code docstrings that is both nice to look at and easy to navigate. Support for a proper table of content navigation down to each class/module‚Äôs member. Nice looking summary tables listing modules' and classes' contents.  This article targets an audience of FOSS maintainers who are unhappy with the state of their project‚Äôs API documentation, and are frustrated with the process of improving it. A basic understanding of Sphinx as well as an existing documentation setup is assumed. This article basically contains everything I wish I was told when I first started on my API reference improvement journey. For the beginners, I‚Äôll provide pointers to help setting up a basic Sphinx.\nNote that although this article is structured as a tutorial, it covers tips and techniques which are likely useful for other kinds of documentation customisation.\nBasic setup As stated above, the basic steps to setup a Sphinx-based documentation project are outside the scope of the present article. I suggest reviewing the following resources to get started:\n @Mariatta made a brilliant tutorial on how to kick-start a Sphinx documentation project. Thomas Cokelaer has a very nice reStructuredText cheat sheet. Simon Willison wrote another cheat sheet which covers ‚Äúthe subset of reStructuredText worth committing to memory‚Äù. Obviously, Sphinx‚Äôs documentation is an important resource. Although it is somewhat arid for the newcomer, I strongly suggest not giving up on it. I had multiple ‚Äúoh there it is!‚Äù moments with it in the process of writing this article. Finally, Read the Docs is likely the best place to host your documentation. It‚Äôs very simple to setup and free for open source projects.  As for the theme, my preference goes for Pradyun Gedam‚Äôs Furo. I‚Äôm using it with the default configuration, so the only requirement is to enable it in your conf.py file:\nhtml_theme = \"furo\" Note that some of the CSS provided in this article may need adjustments should you opt for a different theme.\nAutoapi setup After trying both autodoc/autosummary and Sphinx AutoAPI, I opted to use the latter. Here are the main reasons behind this choice:\n Autosummary does not generate TOC entries for API elements such as classes/modules and their members. This is due to a long-standing Sphinx limitation. Autoapi works around this limitation (albeit imperfectly, as we‚Äôll later note). Autosummary defaults to not generating anything and is in my experience frustrating to setup. In contrast, autoapi produces usable output out-of-the-box. Templates are easier to write thanks to the rich ‚Äúmapper‚Äù objects AutoAPI provides after parsing your code (see the AutoAPI objects section below).  Note that there are two things called ‚Äúautoapi‚Äù floating on the Internet: the Sphinx AutoAPI project (documentation) is the good one. The other one is unmaintained and barely documented. Make sure you don‚Äôt loose time dealing with the wrong one.\nBasics Setting up Sphinx AutoAPI is covered in their documentation. It boils down to the following steps.\n Install the sphinx-autoapi package: $ pip install sphinx-autoapi  Add AutoAPI it to the Sphinx extension list: extensions = [ ..., 'autoapi.extension', ]  List your package directories (or the directory containing them) and set basic options: autoapi_dirs = ['../mypackage'] autoapi_type = \"python\"  Add the generated documentation to your index.rst toctree: .. toctree:: :maxdepth: 3... autoapi/index   Setting up templates We will customise Sphinx AutoAPI‚Äôs default templates. The easiest is to copy Sphinx AutoAPI‚Äôs default templates in your project to serve as a starting point.\nFirst, run the following commands (adjusting for your Python version) from your documentation directory:\n$ mkdir _templates $ mkdir _template/autoapi $ cp $VIRTUAL_ENV/lib/python3.10/site-packages/autoapi/templates/index.rst _templates/autoapi/ $ cp -r $VIRTUAL_ENV/lib/python3.10/site-packages/autoapi/templates/python _templates/autoapi/ Then, tell Sphinx AutoAPI of its template directory in your conf.py file:\nautoapi_template_dir = \"_templates/autoapi\" A useful tip is to make a Git commit just after copying the built-in templates, such that you can track (and revert) your modifications. I‚Äôve used this extensively while working on my templates.\nAt this point, I suggest spending some time to become acquainted with the built-in templates and how they are organised and implemented. If you haven‚Äôt used it before, it is also useful to review the Jinja2 templating language documentation.\nOther configuration options autoapi_options The autoapi_options controls various aspect of the generated documentation, including the type of class/module members that are listed. Its default value is sensible but I still felt like customising it:\nautoapi_options = [ \"members\", \"undoc-members\", \"show-inheritance\", \"show-module-summary\", \"imported-members\", ] In particular, I want the summary at the top of the module‚Äôs documentation (show-module-summary), but we will heavily customise it. Check the documentation for a list of available options and their descriptions.\nautoapi_keep_files Another useful option is autoapi_keep_files. Sphinx-autoapi generates .rst pages for the documentation during the build process, but defaults to deleting them after completion. It‚Äôs often useful to keep them around for inspection and debugging purposes:\nautoapi_keep_files = True autodoc_typehints This is technically an autodoc setting, but Sphinx AutoAPI honours it. It controls if/where type hints are included in the documentation. The possible values are the following:\n \"signature\": type hints are included in the function signature, which appears first in the member‚Äôs documentation \"description\": type hints are included within the function description, when the arguments are listed \"both\": type hints are included in both places \"none\": type hints are not included  My preference goes for \"signature\":\nautodoc_typehints = \"signature\" AutoAPI objects Understanding the Sphinx AutoAPI objects is key to customising templates. They are one of the major difference with respect to autodoc/autosummary.\nIn order to generate the API documentation, the autodoc loads your actual code and uses Python‚Äôs introspection capabilities to extract the required information from your module and class objects. In contrast, Sphinx AutoAPI parses your Python code and builds a collection of so-called ‚Äúmapper‚Äù objects which describe your code and its structure. These objects are then passed on as context to the Jinja2 templating engine. Oddly, the documentation doesn‚Äôt provide a reference about them, but their implementation is easy to read.\nHere is a summary of some of the attributes that are useful when writing templates:\n obj.name Name of the mapped object, e.g. \"MyClass\" or \"my_method\". obj.id Fully qualified name of the object, used for cross-referencing, e.g. \"my_module.MyClass\" or \"my_module.MyClass.my_method\". obj.summary Summary of the object‚Äôs docstring (i.e. the first line). obj.docstring Full docstring of the object. obj.display Indicates whether or not this object should be displayed, based on the options set in conf.py and the result of the autoapi-skip-member event (discussed later). obj.children (Modules and classes only) List children functions, methods, attributes, etc. obj.properties (Functions and methods only) List of properties, such as \"classmethod\", \"staticmethod\"\", \"abstractmethod\", \"property\", etc. obj.obj.args (Functions and methods only) List of 4-tuples describing the function‚Äôs arguments. The first item is the star operator if any (\"*\", \"**\", or None), the second is the argument name, the third is the argument type or None, and the fourth is the argument default value or None. This key piece of data will enable us to recreate the signatures according to our needs.  When working on your documentation, it is often useful to inspect the contents of these mapper objects using a debugger. This can be achieved by adding an handler for the autoapi-skip-member event and setting a conditional breakpoint:\ndef skip_member(app, what, name, obj, skip, options): # conditional breakpoint here return skip def setup(sphinx): sphinx.connect(\"autoapi-skip-member\", skip_member) This event will be triggered for every single Python object parsed from your code. By breaking, for example, when obj.name == \"my_module\", the obj argument and its children can be fully inspected. I use the following run configuration in my IDE for this:\n Execute module: sphinx.cmd.build Parameters: -M html . _build Working directory: docs/  An autosummary-like macro By default, Sphinx AutoAPI provides a summary list of classes, functions, and attributes at the top of a module‚Äôs documentation, which is very nice. Our objective is to add a similar table at the top of each class description, to facilitate navigation. However, Sphinx AutoAPI uses its own autoapisummary directive, which derives from autosummary‚Äôs autosummary directive. Both suffer from the following limitations:\n The way callables are rendered is hard-coded and cannot be customised via templates. In particular, if autodoc_typehints is set to \"signature\" or \"both\", autosummary will include type hints in the summary table as well. Unfortunately, this dramatically increases the length of the signature, which is detrimental to the table layout and usability. Alternatively, signatures can be entirely removed by using the :nosignatures: option. However, in this case, not even parenthesis are displayed, which hides the callable nature of the function. The best compromise is to have the full signature with their arguments, but without typing annotations. Properties are listed as functions, including their signature. This hides the fact that, API-wise, they behave as data members (though it would still be useful to indicate that they are in fact properties). There is not indication that a method is abstract, static, or class-based.  To address these shortcomings, we will create a Jinja2 template macro to replicate and improve on autosummary/autoapisummary functionality.1\nOur aim is to create tables where callable have their full ‚Äì but unannotated ‚Äì signature, where properties are indicated as such but rendered as attributes, and where static, class, and abstract methods are marked as such. Here is an example of this:\nBasic macro setup The basic insight is that a summary table can be implemented using Sphinx‚Äôs list-table:\n.. list-table:: Title :header-rows: 0 :widths: auto * - Item 1 - This is the description of the first item. * - Name 2 - This is also a description, but this time for the second item. * - ... - ...Such a table can be generated with the following Jinja macro:\n{% macro auto_summary(objs, title='') -%} .. list-table:: {{ title }} :header-rows: 0 :widths: auto {% for obj in objs %} * - obj.name - obj.summary {% endfor %} {% endmacro %} To test this, create a file named _templates/autoapi/macros.rst and add the code above. Then, make the following edits to the _templates/autoapi/python/module.rst file:\n At the top of the file, import macros.rst to make it available for use: {% import 'macros.rst' as macros %}  Locate where the class summary is generated: .. autoapisummary:: {% for klass in visible_classes %} {{ klass.id }} {% endfor %}  Replace the code above by a call to our macro: {{ macros.auto_summary(visible_classes, title=\"Classes\") }}   Here is the result I obtain with my project:\nThis is a good start, but we‚Äôre obviously far from the result we want. To start with, no cross-reference links are generated. And, had we passed functions or methods instead of classes to our macro, no signature would have been generated.\nCustom labels Before fixing our macro, we must discuss these nice looking ‚Äúprop‚Äù, ‚Äústatic‚Äù, and ‚Äúclass‚Äù tag-like labels in the example tables above. These are implemented using a custom role with some CSS attached to it.\nThis StackOverflow answer explains how to create a custom role and make it globally available to your documentation. Basically, just add the following to your conf.py file:\nrst_prolog = \"\"\" .. role:: summarylabel \"\"\" The role directive creates a new role which can then be used as follows:\n:summarylabel:`My Label`Sphinx generates the corresponding HTML code:\nspan class=\"summarylabel\"My labelspan Since it sets an HTML class named after the role, it‚Äôs easy to adjust the label appearance using some custom CSS. Create a file named _static/css/custom.css in your documentation directory and add the following CSS:\nspan.summarylabel { background-color: var(--color-foreground-secondary); color: var(--color-background-secondary); font-size: 70%; padding-left: 2px; padding-right: 2px; border-radius: 3px; vertical-align: 15%; padding-bottom: 2px; filter: opacity(40%); } Note the use of CSS variables in order to support Furo‚Äôs dynamic night mode feature.\nFinally, we must tell Sphinx about this CSS file in the conf.py file:\nhtml_css_files = [ \"css/custom.css\", ] Customising the table appearance A similar CSS approach can be used to customise the appearance of the summary table itself. By adding the :class: option to the list-table directive, we can tell Sphinx to attach an HTML class to the  element, which we can then customise with CSS:\n.. list-table:: Title :header-rows: 0 :widths: auto :class: summarytable * - ... - ...For my project, the only change I made to the default appearance is to force the table to span the entire width regardless of its contents. This can be done by adding the following code to our custom.css file:\ntable.summarytable { width: 100%; } Putting it all together We are now ready to put everything together and improve our auto_summary() macro to our liking. Here is the final code for macros.rst:\n{% macro _render_item_name(obj, sig=False) -%} :py:obj:`{{ obj.name }} {{ obj.id }}` {%- if sig -%} \\ ( {%- for arg in obj.obj.args -%} {%- if arg[0] %}{{ arg[0]|replace('*', '\\*') }}{% endif -%}{{ arg[1] -}} {%- if not loop.last %}, {% endif -%} {%- endfor -%} ){%- endif -%} {%- endmacro %} {% macro _item(obj, sig=False, label='') %} * - {{ _render_item_name(obj, sig) }} - {% if label %}:summarylabel:`{{ label }}` {% endif %}{% if obj.summary %}{{ obj.summary }}{% else %}\\-{% endif +%} {% endmacro %} {% macro auto_summary(objs, title='') -%} .. list-table:: {{ title }} :header-rows: 0 :widths: auto :class: summarytable {% for obj in objs -%} {%- set sig = (obj.type in ['method', 'function'] and not 'property' in obj.properties) -%} {%- if 'property' in obj.properties -%} {%- set label = 'prop' -%} {%- elif 'classmethod' in obj.properties -%} {%- set label = 'class' -%} {%- elif 'abstractmethod' in obj.properties -%} {%- set label = 'abc' -%} {%- elif 'staticmethod' in obj.properties -%} {%- set label = 'static' -%} {%- else -%} {%- set label = '' -%} {%- endif -%} {{- _item(obj, sig=sig, label=label) -}} {%- endfor -%} {% endmacro %} The work is now split in three macros:\n auto_summary() This is the ‚Äúpublic‚Äù macro. It generates a table based on a list of mapper objects, with an optional title. It iterates over the list of objects, and, for each of them, determines if the signature should be generated (functions and non-property methods) and if some label should be attached. It then uses _item() to generate each object‚Äôs code. _item() This helper macro generates the code for each object, prepending a label to the summary if requested. _render_item_name() This helper macro focuses on generating the properly-cross-referenced object name. If the signature is requested, it iterates over the obj.obj.args list to produce a full (but unannotated) list of arguments.  Improving the default templates With our auto_summary() macro completed, we are now ready to customise our templates, but we still have one issue to resolve before we do so.\nCategorising objects with a custom Jinja2 test As we saw in the AutoAPI objects section, mapper objects representing modules or classes have a children attribute which lists the objects it contains. For example, a module‚Äôs children attribute lists all the classes, functions and attributes defined within it.\nIn order to categorise these children into separate sub-lists, the built-in templates heavily use the selectattr() and rejectattr() filters. For example, a list of classes in a module can be obtained as follows:\n{% set visible_children = module_object.children|selectattr(\"display\")|rejectattr(\"imported\")|list %} {% set visible_classes = visible_children|selectattr(\"type\", \"equalto\", \"class\")|list %} This code selects the visible (but not imported) children from module_object, and then further selects children which have their type set to \"class\". In the code above, \"equalto\" is known as a Jinja test. There are many such built-in tests in Jinja2.\nAs stated before, we aim to categorise properties as attributes instead of methods. To that end, we will have to filter methods whose properties attribute contains \"property\". Intuition dictates that the following code achieves this:\n{% set property_methods = all_methods|selectattr(\"properties\", \"contains\", \"property\")|list %} The bad news is that no such \"contains\" test exists by default in Jinja2. The good news is that it is trivial to add one.\nFirst, the actual test must be written. Add the following code to your conf.py file:\ndef contains(seq, item): return item in seq Then, we just need to add this test to the Jinja environment. Sphinx AutoAPI provides a hook for that:\ndef prepare_jinja_env(jinja_env) - None: jinja_env.tests[\"contains\"] = contains autoapi_prepare_jinja_env = prepare_jinja_env With this in your conf.py file, the template code above will work as expected.\nUpdating templates We previously replaced one of module.rst‚Äôs use of autoapisummary by our auto_summary() macro (see Basic macro setup). It is now time to generalise the use of our macro. At this stage, the details of how this is done is to a large extent up to reader‚Äôs taste. The templates of vsketch can serve as fully-functional example and can readily be used in another projects.\nFor the module.rst template, I have opted to simplify the overview‚Äôs structure by just generating tables (without headings) for classes, functions, and attributes:\n{% if \"show-module-summary\" in autoapi_options and (visible_classes or visible_functions) %} {% block classes scoped %} {% if visible_classes %} {{ macros.auto_summary(visible_classes, title=\"Classes\") }} {% endif %} {% endblock %} {% block functions scoped %} {% if visible_functions %} {{ macros.auto_summary(visible_functions, title=\"Functions\") }} {% endif %} {% endblock %} {% block attributes scoped %} {% if visible_attributes %} {{ macros.auto_summary(visible_attributes, title=\"Attributes\") }} {% endif %} {% endblock %} {% endif %} For the class.rst template, I chose to rework the structure of the documentation into two rubrics:\n{% if visible_methods or visible_attributes %} .. rubric:: Overview {% set summary_methods = visible_methods|rejectattr(\"properties\", \"contains\", \"property\")|list %} {% set summary_attributes = visible_attributes + visible_methods|selectattr(\"properties\", \"contains\", \"property\")|list %} {% if summary_attributes %} {{ macros.auto_summary(summary_attributes, title=\"Attributes\")|indent(3) }} {% endif %} {% if summary_methods %} {{ macros.auto_summary(summary_methods, title=\"Methods\")|indent(3) }} {% endif %} .. rubric:: Members {% for attribute in visible_attributes %} {{ attribute.render()|indent(3) }} {% endfor %} {% for method in visible_methods %} {{ method.render()|indent(3) }} {% endfor %} {% endif %} Note the use of the custom \"contains\" Jinja2 test we implemented earlier.\nHiding submodules Sphinx AutoAPI include all subpackages and submodules recursively, unless those are marked as private by prefixing their name with an underscore. In my packages' __init__.py file, I carefully import from submodules the objects which are meant to be public, but haven‚Äôt necessarily marked the submodules as private. Sphinx AutoAPI has no option to control whether or not to add them (I suggested adding one), so I had to filter them out manually. This is done with the autoapi-skip-member event handler we mentioned earlier:\ndef skip_member(app, what, name, obj, skip, options): # skip submodules if what == \"module\": skip = True return skip def setup(sphinx): sphinx.connect(\"autoapi-skip-member\", skip_member) Hiding members Likewise, it may happen that you want to hide specific members from the documentation without marking them as private. Again, the autoapi-skip-member event handler can do that. The following example is based from actual code in vsketch:\ndef skip_member(app, what, name, obj, skip, options): if \"vsketch.SketchClass\" in name: if obj.name in [ \"vsk\", \"param_set\", \"execute_draw\", \"ensure_finalized\", \"execute\", \"get_params\", \"set_param_set\", ]: skip = True return skip Note that name is the fully qualified name of the object, so the vsk member has name set to vsketch.SketchClass.vsk. In contrast, obj.name is just the base name.\nAlso, for this to work as expected for modules, I had to change the following line in module.rst\n{% set visible_children = obj.children|selectattr(\"short_name\", \"in\", obj.all)|list %} into\n{% set visible_children = obj.children|selectattr(\"display\")|selectattr(\"short_name\", \"in\", obj.all)|list %} Without this modification, objects marked as skipped would show up in the summary tables.\nOrdering By default, Sphinx AutoAPI generates the documentation in the same order as the code. This can be changed to alphabetical order, I like being in control from the code.\nIn vsketch, the top level content is determined by the imports in my package‚Äôs __init__.py file, so the import statements themself matter. Since I‚Äôm using isort, I had to short-circuit it in this particular case:\n# vsketch/__init__.py # isort: skip_file # Ordered for the documentation from .vsketch import Vsketch from .shape import Shape from .sketch_class import SketchClass, Param, ParamType from .easing import EASING_FUNCTIONS from .utils import working_directory Conclusion Well, this ended up being much longer than anticipated üòÖ ‚Äì if you made it this far, congratulations! üéâ\nHere is what we covered:\n We built on a basic Sphinx project and added AutoAPI to generate an API reference documentation. We created custom templates based on the built-in templates provided by AutoAPI. We reviewed the mapper objects created by AutoAPI to described our code. We learned how to use a debugger to easily inspect these objects. We crafted an autosummary-like macro named auto_summary() to build beautiful summary tables. We customised these tables with custom CSS. We used a custom Sphinx role and CSS to create tag-like labels to be used in the summary tables. We learned of Jinja2‚Äôs tests and created a custom one. We controlled the visibility of submodules and members using a autoapi-skip-member event handler. We learned how to control ordering from our code.  Like any software project, improving the documentation is a never-ending endeavour. As it turns out, there is one remaining issue that has been bugging me and is yet unresolved. Due to a limitation in Sphinx, AutoAPI has a tendency to mangle the TOC ordering, especially when section headings are emitted from the templates. Check these two issues for more information. Hopefully they‚Äôll get solved in the future.\nI shall conclude by stating that, by all means, I do not consider myself a Sphinx expert ‚Äî much to the contrary. I did spend a lot of time improving my API documentation, and figured it would be wasteful not to share my findings, especially given the relative scarcity of information on advanced Sphinx usage patterns. As a result, it is rather likely that I made mistakes and sub-optimal choices. If so, please do provide feedback, and I‚Äôll update this article to improve it.\nEdit: updated title and intro to clarify the nature of the API discussed, i.e. Python API (2022-05-11).\n  Ideally, these shortcomings would be addressed using an extension and a custom directive, or even by contributing the improvement back to the Sphinx or AutoAPI projects. This is sadly beyond my skills. Also, the template method is anyway useful for highly specific requirements where writing an extension wouldn‚Äôt be warranted.¬†‚Ü©Ô∏é\n   ","wordCount":"3730","inLanguage":"en","image":"https://bylr.info/sphinx-autoapi/banner.png","datePublished":"2022-05-10T00:00:00Z","dateModified":"2022-05-11T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://bylr.info/articles/2022/05/10/api-doc-with-sphinx-autoapi/"},"publisher":{"@type":"Organization","name":"bylr.info","logo":{"@type":"ImageObject","url":"https://bylr.info/favicon.ico"}}}</script>
</head>
<body id=top>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://bylr.info/ accesskey=h title="bylr.info (Alt + H)">bylr.info</a>
<span class=logo-switches>
</span>
</div>
<ul id=menu>
<li>
<a href=https://bylr.info/about/ title=about>
<span>about</span>
</a>
</li>
<li>
<a href=https://bylr.info/archives title=archives>
<span>archives</span>
</a>
</li>
<li>
<a href=https://bylr.info/tags/ title=tags>
<span>tags</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Generating beautiful Python API documentation with Sphinx AutoAPI
</h1>
<div class=post-meta><span title="2022-05-10 00:00:00 +0000 UTC">May 10, 2022</span>&nbsp;¬∑&nbsp;<span title="Last updated 2022-05-11 00:00:00 +0000 UTC">Last updated on May 11, 2022</span>&nbsp;|&nbsp;<a href=https://github.com/abey79/abey79.github.io/blob/main/content/articles/sphinx-autoapi.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header>
<figure class=entry-cover><img loading=lazy src=https://bylr.info/sphinx-autoapi/banner.png alt="close-up shot of a rotring .35mm pen on a plotted hatch fill test chart">
</figure><div class=toc>
<details open>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#basic-setup aria-label="Basic setup">Basic setup</a></li>
<li>
<a href=#autoapi-setup aria-label="Autoapi setup">Autoapi setup</a><ul>
<li>
<a href=#basics aria-label=Basics>Basics</a></li>
<li>
<a href=#setting-up-templates aria-label="Setting up templates">Setting up templates</a></li>
<li>
<a href=#other-configuration-options aria-label="Other configuration options">Other configuration options</a><ul>
<li>
<a href=#autoapi_options aria-label=autoapi_options><code>autoapi_options</code></a></li>
<li>
<a href=#autoapi_keep_files aria-label=autoapi_keep_files><code>autoapi_keep_files</code></a></li>
<li>
<a href=#autodoc_typehints aria-label=autodoc_typehints><code>autodoc_typehints</code></a></li></ul>
</li>
<li>
<a href=#autoapi-objects aria-label="AutoAPI objects">AutoAPI objects</a></li></ul>
</li>
<li>
<a href=#an-autosummary-like-macro aria-label="An autosummary-like macro">An <code>autosummary</code>-like macro</a><ul>
<li>
<a href=#basic-macro-setup aria-label="Basic macro setup">Basic macro setup</a></li>
<li>
<a href=#custom-labels aria-label="Custom labels">Custom labels</a></li>
<li>
<a href=#customising-the-table-appearance aria-label="Customising the table appearance">Customising the table appearance</a></li>
<li>
<a href=#putting-it-all-together aria-label="Putting it all together">Putting it all together</a></li></ul>
</li>
<li>
<a href=#improving-the-default-templates aria-label="Improving the default templates">Improving the default templates</a><ul>
<li>
<a href=#categorising-objects-with-a-custom-jinja2-test aria-label="Categorising objects with a custom Jinja2 test">Categorising objects with a custom Jinja2 test</a></li>
<li>
<a href=#updating-templates aria-label="Updating templates">Updating templates</a></li>
<li>
<a href=#hiding-submodules aria-label="Hiding submodules">Hiding submodules</a></li>
<li>
<a href=#hiding-members aria-label="Hiding members">Hiding members</a></li>
<li>
<a href=#ordering aria-label=Ordering>Ordering</a></li></ul>
</li>
<li>
<a href=#conclusion aria-label=Conclusion>Conclusion</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>Following a recent <a href="https://twitter.com/abey79/status/1521484512596746246?s=20&t=3kEAgQUDFiJDRzz77UdTgA">discussion</a> on Twitter, I decided to take yet another deep dive in my Python projects' documentation and fix once and for all the issues I had with it. I first focused on the automatically-generated API reference section and this article details the results of my finding. Specifically, I&rsquo;m using <em>vsketch</em>&rsquo;s <a href=https://vsketch.readthedocs.io/en/latest/autoapi/vsketch/index.html>API reference</a>, which I recently updated, as an example (<a href=https://github.com/abey79/vsketch/tree/master/docs>documentation source</a>.</p>
<p>This article addresses the following objectives:</p>
<ul>
<li>Produce a beautiful API documentation based on the code docstrings that is both nice to look at and easy to navigate.</li>
<li>Support for a proper table of content navigation down to each class/module&rsquo;s member.</li>
<li>Nice looking summary tables listing modules' and classes' contents.</li>
</ul>
<img src=/sphinx-autoapi/example_doc.png alt="Example of documentation generated with this article's techniques" width=80% style=display:block;margin-left:auto;margin-right:auto>
<p>This article targets an audience of FOSS maintainers who are unhappy with the state of their project&rsquo;s API documentation, and are frustrated with the process of improving it. A basic understanding of Sphinx as well as an existing documentation setup is assumed. This article basically contains everything I wish I was told when I first started on my API reference improvement journey. For the beginners, I&rsquo;ll provide pointers to help setting up a basic Sphinx.</p>
<p>Note that although this article is structured as a tutorial, it covers tips and techniques which are likely useful for other kinds of documentation customisation.</p>
<h2 id=basic-setup>Basic setup<a hidden class=anchor aria-hidden=true href=#basic-setup>#</a></h2>
<p>As stated above, the basic steps to setup a Sphinx-based documentation project are outside the scope of the present article. I suggest reviewing the following resources to get started:</p>
<ul>
<li><a href=https://twitter.com/mariatta>@Mariatta</a> made a <em>brilliant</em> <a href=https://sphinx-intro-tutorial.readthedocs.io/>tutorial</a> on how to kick-start a Sphinx documentation project.</li>
<li><a href=https://thomas-cokelaer.info>Thomas Cokelaer</a> has a very nice reStructuredText <a href=https://thomas-cokelaer.info/tutorials/sphinx/rest_syntax.html>cheat sheet</a>.</li>
<li><a href=https://simonwillison.net>Simon Willison</a> wrote another <a href=https://simonwillison.net/2018/Aug/25/restructuredtext/>cheat sheet</a> which covers &ldquo;the subset of reStructuredText worth committing to memory&rdquo;.</li>
<li>Obviously, Sphinx&rsquo;s <a href=https://www.sphinx-doc.org/en/master/>documentation</a> is an important resource. Although it is somewhat arid for the newcomer, I strongly suggest not giving up on it. I had multiple &ldquo;oh there it is!&rdquo; moments with it in the process of writing this article.</li>
<li>Finally, <a href=https://readthedocs.org>Read the Docs</a> is likely the best place to host your documentation. It&rsquo;s very simple to setup and free for open source projects.</li>
</ul>
<p>As for the theme, my preference goes for <a href=https://pradyunsg.me>Pradyun Gedam</a>&rsquo;s <a href=https://github.com/pradyunsg/furo>Furo</a>. I&rsquo;m using it with the default configuration, so the only requirement is to enable it in your <code>conf.py</code> file:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>html_theme <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;furo&#34;</span>
</code></pre></div><p>Note that some of the CSS provided in this article may need adjustments should you opt for a different theme.</p>
<h2 id=autoapi-setup>Autoapi setup<a hidden class=anchor aria-hidden=true href=#autoapi-setup>#</a></h2>
<p>After trying both autodoc/autosummary and Sphinx AutoAPI, I opted to use the latter. Here are the main reasons behind this choice:</p>
<ul>
<li>Autosummary does not generate TOC entries for API elements such as classes/modules and their members. This is due to a <a href=https://github.com/sphinx-doc/sphinx/issues/6316>long-standing Sphinx limitation</a>. Autoapi works around this limitation (albeit imperfectly, as we&rsquo;ll later note).</li>
<li>Autosummary defaults to <a href=https://github.com/sphinx-doc/sphinx/issues/7912>not generating anything</a> and is in my experience frustrating to setup. In contrast, autoapi produces usable output out-of-the-box.</li>
<li>Templates are easier to write thanks to the rich &ldquo;mapper&rdquo; objects AutoAPI provides after parsing your code (see the <a href=#autoapi-objects>AutoAPI objects</a> section below).</li>
</ul>
<p>Note that there are two things called &ldquo;autoapi&rdquo; floating on the Internet: the <a href=https://github.com/readthedocs/sphinx-autoapi>Sphinx AutoAPI</a> project (<a href=https://sphinx-autoapi.readthedocs.io/en/latest/>documentation</a>) is the good one. The <a href=https://autoapi.readthedocs.io>other one</a> is unmaintained and barely documented. Make sure you don&rsquo;t loose time dealing with the wrong one.</p>
<h3 id=basics>Basics<a hidden class=anchor aria-hidden=true href=#basics>#</a></h3>
<p>Setting up Sphinx AutoAPI is covered in their <a href=https://sphinx-autoapi.readthedocs.io/en/latest/tutorials.html#python>documentation</a>. It boils down to the following steps.</p>
<ol>
<li>Install the <code>sphinx-autoapi</code> package:
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ pip install sphinx-autoapi
</code></pre></div></li>
<li>Add AutoAPI it to the Sphinx extension list:
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>extensions <span style=color:#000;font-weight:700>=</span> [
    <span style=color:#000;font-weight:700>...</span>,
    <span style=color:#d14>&#39;autoapi.extension&#39;</span>,
]
</code></pre></div></li>
<li>List your package directories (or the directory containing them) and set basic options:
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>autoapi_dirs <span style=color:#000;font-weight:700>=</span> [<span style=color:#d14>&#39;../mypackage&#39;</span>]
autoapi_type <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;python&#34;</span>
</code></pre></div></li>
<li>Add the generated documentation to your <code>index.rst</code> toctree:
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rst data-lang=rst>.. <span style=color:#000;font-weight:700>toctree</span>::<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>   <span style=color:#458;font-weight:700>:maxdepth:</span> <span style=color:#900;font-weight:700>3</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-weight:700;font-style:italic>   ...
</span><span style=color:#999;font-weight:700;font-style:italic>   autoapi/index
</span></code></pre></div></li>
</ol>
<h3 id=setting-up-templates>Setting up templates<a hidden class=anchor aria-hidden=true href=#setting-up-templates>#</a></h3>
<p>We will customise Sphinx AutoAPI&rsquo;s default templates. The easiest is to copy Sphinx AutoAPI&rsquo;s default templates in your project to serve as a starting point.</p>
<p>First, run the following commands (adjusting for your Python version) from your documentation directory:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ mkdir _templates
$ mkdir _template/autoapi
$ cp <span style=color:teal>$VIRTUAL_ENV</span>/lib/python3.10/site-packages/autoapi/templates/index.rst _templates/autoapi/
$ cp -r <span style=color:teal>$VIRTUAL_ENV</span>/lib/python3.10/site-packages/autoapi/templates/python _templates/autoapi/ 
</code></pre></div><p>Then, tell Sphinx AutoAPI of its template directory in your <code>conf.py</code> file:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>autoapi_template_dir <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;_templates/autoapi&#34;</span>
</code></pre></div><p>A useful tip is to make a Git commit just after copying the built-in templates, such that you can track (and revert) your modifications. I&rsquo;ve used this extensively while working on my templates.</p>
<p>At this point, I suggest spending some time to become acquainted with the built-in templates and how they are organised and implemented. If you haven&rsquo;t used it before, it is also useful to review the Jinja2 templating language <a href=https://jinja.palletsprojects.com>documentation</a>.</p>
<h3 id=other-configuration-options>Other configuration options<a hidden class=anchor aria-hidden=true href=#other-configuration-options>#</a></h3>
<h4 id=autoapi_options><code>autoapi_options</code><a hidden class=anchor aria-hidden=true href=#autoapi_options>#</a></h4>
<p>The <code>autoapi_options</code> controls various aspect of the generated documentation, including the type of class/module members that are listed. Its default value is sensible but I still felt like customising it:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>autoapi_options <span style=color:#000;font-weight:700>=</span> [
    <span style=color:#d14>&#34;members&#34;</span>,
    <span style=color:#d14>&#34;undoc-members&#34;</span>,
    <span style=color:#d14>&#34;show-inheritance&#34;</span>,
    <span style=color:#d14>&#34;show-module-summary&#34;</span>,
    <span style=color:#d14>&#34;imported-members&#34;</span>,
]
</code></pre></div><p>In particular, I want the summary at the top of the module&rsquo;s documentation (<code>show-module-summary</code>), but we will heavily customise it. Check <a href=https://sphinx-autoapi.readthedocs.io/en/latest/reference/config.html#confval-autoapi_options>the documentation</a> for a list of available options and their descriptions.</p>
<h4 id=autoapi_keep_files><code>autoapi_keep_files</code><a hidden class=anchor aria-hidden=true href=#autoapi_keep_files>#</a></h4>
<p>Another useful option is <code>autoapi_keep_files</code>. Sphinx-autoapi generates .rst pages for the documentation during the build process, but defaults to deleting them after completion. It&rsquo;s often useful to keep them around for inspection and debugging purposes:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>autoapi_keep_files <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>True</span>
</code></pre></div><h4 id=autodoc_typehints><code>autodoc_typehints</code><a hidden class=anchor aria-hidden=true href=#autodoc_typehints>#</a></h4>
<p>This is technically an autodoc setting, but Sphinx AutoAPI honours it. It controls if/where type hints are included in the documentation. The possible values are the following:</p>
<ul>
<li><code>"signature"</code>: type hints are included in the function signature, which appears first in the member&rsquo;s documentation</li>
<li><code>"description"</code>: type hints are included within the function description, when the arguments are listed</li>
<li><code>"both"</code>: type hints are included in both places</li>
<li><code>"none"</code>: type hints are not included</li>
</ul>
<p>My preference goes for <code>"signature"</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>autodoc_typehints <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;signature&#34;</span>
</code></pre></div><h3 id=autoapi-objects>AutoAPI objects<a hidden class=anchor aria-hidden=true href=#autoapi-objects>#</a></h3>
<p>Understanding the Sphinx AutoAPI objects is key to customising templates. They are one of the major difference with respect to autodoc/autosummary.</p>
<p>In order to generate the API documentation, the autodoc <em>loads</em> your actual code and uses Python&rsquo;s introspection capabilities to extract the required information from your module and class objects. In contrast, Sphinx AutoAPI <em>parses</em> your Python code and builds a collection of so-called &ldquo;mapper&rdquo; objects which describe your code and its structure. These objects are then passed on as context to the Jinja2 templating engine. Oddly, the documentation doesn&rsquo;t provide a reference about them, but their <a href=https://github.com/readthedocs/sphinx-autoapi/blob/master/autoapi/mappers/python/objects.py>implementation</a> is easy to read.</p>
<p>Here is a summary of some of the attributes that are useful when writing templates:</p>
<dl>
<dt><code>obj.name</code></dt>
<dd>Name of the mapped object, e.g. <code>"MyClass"</code> or <code>"my_method"</code>.</dd>
<dt><code>obj.id</code></dt>
<dd>Fully qualified name of the object, used for cross-referencing, e.g. <code>"my_module.MyClass"</code> or <code>"my_module.MyClass.my_method"</code>.</dd>
<dt><code>obj.summary</code></dt>
<dd>Summary of the object&rsquo;s docstring (i.e. the first line).</dd>
<dt><code>obj.docstring</code></dt>
<dd>Full docstring of the object.</dd>
<dt><code>obj.display</code></dt>
<dd>Indicates whether or not this object should be displayed, based on the options set in <code>conf.py</code> and the result of the <code>autoapi-skip-member</code> event (discussed later).</dd>
<dt><code>obj.children</code></dt>
<dd><em>(Modules and classes only)</em> List children functions, methods, attributes, etc.</dd>
<dt><code>obj.properties</code></dt>
<dd><em>(Functions and methods only)</em> List of properties, such as <code>"classmethod"</code>, <code>"staticmethod"</code>", <code>"abstractmethod"</code>, <code>"property"</code>, etc.</dd>
<dt><code>obj.obj.args</code></dt>
<dd><em>(Functions and methods only)</em> List of 4-tuples describing the function&rsquo;s arguments. The first item is the star operator if any (<code>"*"</code>, <code>"**"</code>, or <code>None</code>), the second is the argument name, the third is the argument type or <code>None</code>, and the fourth is the argument default value or <code>None</code>. This key piece of data will enable us to recreate the signatures according to our needs.</dd>
</dl>
<p>When working on your documentation, it is often useful to inspect the contents of these mapper objects using a debugger. This can be achieved by adding an handler for the <code>autoapi-skip-member</code> event and setting a conditional breakpoint:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>skip_member</span>(app, what, name, obj, skip, options):
    <span style=color:#998;font-style:italic># conditional breakpoint here</span>
    <span style=color:#000;font-weight:700>return</span> skip


<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>setup</span>(sphinx):
    sphinx<span style=color:#000;font-weight:700>.</span>connect(<span style=color:#d14>&#34;autoapi-skip-member&#34;</span>, skip_member)
</code></pre></div><p>This event will be triggered for every single Python object parsed from your code. By breaking, for example, when <code>obj.name == "my_module"</code>, the <code>obj</code> argument and its children can be fully inspected. I use the following run configuration in my IDE for this:</p>
<ul>
<li>Execute module: <code>sphinx.cmd.build</code></li>
<li>Parameters: <code>-M html . _build</code></li>
<li>Working directory: <code>docs/</code></li>
</ul>
<h2 id=an-autosummary-like-macro>An <code>autosummary</code>-like macro<a hidden class=anchor aria-hidden=true href=#an-autosummary-like-macro>#</a></h2>
<p>By default, Sphinx AutoAPI provides a summary list of classes, functions, and attributes at the top of a module&rsquo;s documentation, which is very nice. Our objective is to add a similar table at the top of each class description, to facilitate navigation. However, Sphinx AutoAPI uses its own <code>autoapisummary</code> directive, which derives from autosummary&rsquo;s <code>autosummary</code> directive. Both suffer from the following limitations:</p>
<ul>
<li>The way callables are rendered is hard-coded and cannot be customised via templates. In particular, if <code>autodoc_typehints</code> is set to <code>"signature"</code> or <code>"both"</code>, <code>autosummary</code> will include type hints in the summary table as well. Unfortunately, this dramatically increases the length of the signature, which is detrimental to the table layout and usability. Alternatively, signatures can be entirely removed by using the <code>:nosignatures:</code> option. However, in this case, not even parenthesis are displayed, which hides the callable nature of the function. The best compromise is to have the full signature with their arguments, but without typing annotations.</li>
<li>Properties are listed as functions, including their signature. This hides the fact that, API-wise, they behave as data members (though it would still be useful to indicate that they are in fact properties).</li>
<li>There is not indication that a method is abstract, static, or class-based.</li>
</ul>
<p>To address these shortcomings, we will create a <a href=https://jinja.palletsprojects.com>Jinja2</a> template macro to replicate and improve on <code>autosummary</code>/<code>autoapisummary</code> functionality.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p>
<p>Our aim is to create tables where callable have their full ‚Äì but unannotated ‚Äì signature, where properties are indicated as such but rendered as attributes, and where static, class, and abstract methods are marked as such. Here is an example of this:</p>
<img src=/sphinx-autoapi/demo_class_doc.png alt="Example of documentation generated with this article's techniques" width=80% style=display:block;margin-left:auto;margin-right:auto>
<h3 id=basic-macro-setup>Basic macro setup<a hidden class=anchor aria-hidden=true href=#basic-macro-setup>#</a></h3>
<p>The basic insight is that a summary table can be implemented using Sphinx&rsquo;s <a href=https://docutils.sourceforge.io/docs/ref/rst/directives.html#list-table><code>list-table</code></a>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rst data-lang=rst>.. <span style=color:#000;font-weight:700>list-table</span>:: Title<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>   <span style=color:#458;font-weight:700>:header-rows:</span> <span style=color:#900;font-weight:700>0</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>   <span style=color:#458;font-weight:700>:widths:</span> <span style=color:#900;font-weight:700>auto</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>   
   <span style=color:#099>*</span> - Item 1<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>     <span style=color:#099>-</span> This is the description of the first item.<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>   <span style=color:#099>*</span> - Name 2<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>     - This is also a description, but this time for the second item.<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>   <span style=color:#099>*</span> - ...<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>     - ...<span style=color:#a61717;background-color:#e3d2d2>
</span></code></pre></div><img src=/sphinx-autoapi/basic_table.png alt="Example of basic table." width=60% style=display:block;margin-left:auto;margin-right:auto>
<p>Such a table can be generated with the following Jinja macro:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jinja data-lang=jinja><span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>macro</span> <span style=color:teal>auto_summary</span><span style=color:#000;font-weight:700>(</span><span style=color:teal>objs</span><span style=color:#000;font-weight:700>,</span> <span style=color:teal>title</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#39;&#39;</span><span style=color:#000;font-weight:700>)</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>

.. list-table:: <span style=color:#999;font-weight:700;font-style:italic>{{</span> <span style=color:teal>title</span> <span style=color:#999;font-weight:700;font-style:italic>}}</span>
   :header-rows: 0
   :widths: auto

<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>for</span> <span style=color:teal>obj</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>objs</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
    * - obj.name
      - obj.summary
<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endfor</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endmacro</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
</code></pre></div><p>To test this, create a file named <code>_templates/autoapi/macros.rst</code> and add the code above. Then, make the following edits to the <code>_templates/autoapi/python/module.rst</code> file:</p>
<ul>
<li>At the top of the file, import <code>macros.rst</code> to make it available for use:
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jinja data-lang=jinja><span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>import</span> <span style=color:#d14>&#39;macros.rst&#39;</span> <span style=color:#000;font-weight:700>as</span> <span style=color:teal>macros</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
</code></pre></div></li>
<li>Locate where the class summary is generated:
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jinja data-lang=jinja>.. autoapisummary::

<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>for</span> <span style=color:teal>klass</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>visible_classes</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
   <span style=color:#999;font-weight:700;font-style:italic>{{</span> <span style=color:teal>klass.id</span> <span style=color:#999;font-weight:700;font-style:italic>}}</span>
<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endfor</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
</code></pre></div></li>
<li>Replace the code above by a call to our macro:
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jinja data-lang=jinja><span style=color:#999;font-weight:700;font-style:italic>{{</span> <span style=color:teal>macros.auto_summary</span><span style=color:#000;font-weight:700>(</span><span style=color:teal>visible_classes</span><span style=color:#000;font-weight:700>,</span> <span style=color:teal>title</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;Classes&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#999;font-weight:700;font-style:italic>}}</span>
</code></pre></div></li>
</ul>
<p>Here is the result I obtain with my project:</p>
<img src=/sphinx-autoapi/basic_class_table.png alt="Example of basic class table." width=70% style=display:block;margin-left:auto;margin-right:auto>
<p>This is a good start, but we&rsquo;re obviously far from the result we want. To start with, no cross-reference links are generated. And, had we passed functions or methods instead of classes to our macro, no signature would have been generated.</p>
<h3 id=custom-labels>Custom labels<a hidden class=anchor aria-hidden=true href=#custom-labels>#</a></h3>
<p>Before fixing our macro, we must discuss these nice looking &ldquo;prop&rdquo;, &ldquo;static&rdquo;, and &ldquo;class&rdquo; tag-like labels in the example tables above. These are implemented using a custom <a href=https://www.sphinx-doc.org/en/master/usage/restructuredtext/roles.html>role</a> with some CSS attached to it.</p>
<p>This StackOverflow <a href=https://stackoverflow.com/a/9707879/229511>answer</a> explains how to create a custom role and make it globally available to your documentation. Basically, just add the following to your <code>conf.py</code> file:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>rst_prolog <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;&#34;&#34;
</span><span style=color:#d14>.. role:: summarylabel
</span><span style=color:#d14>&#34;&#34;&#34;</span>
</code></pre></div><p>The <code>role</code> directive creates a new role which can then be used as follows:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rst data-lang=rst><span style=color:teal>:summarylabel:</span><span style=color:teal>`My Label`</span><span style=color:#a61717;background-color:#e3d2d2>
</span></code></pre></div><p>Sphinx generates the corresponding HTML code:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>&lt;<span style=color:navy>span</span> <span style=color:teal>class</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;summarylabel&#34;</span>&gt;My label&lt;/<span style=color:navy>span</span>&gt;
</code></pre></div><p>Since it sets an HTML class named after the role, it&rsquo;s easy to adjust the label appearance using some custom CSS. Create a file named <code>_static/css/custom.css</code> in your documentation directory and add the following CSS:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-css data-lang=css><span style=color:navy>span</span>.<span style=color:#458;font-weight:700>summarylabel</span> {
    <span style=color:#000;font-weight:700>background-color</span>: <span style=color:#900;font-weight:700>var</span>(<span style=color:#000;font-weight:700>--</span><span style=color:#000;font-weight:700>color</span><span style=color:#000;font-weight:700>-</span>foreground<span style=color:#000;font-weight:700>-</span>secondary);
    <span style=color:#000;font-weight:700>color</span>: <span style=color:#900;font-weight:700>var</span>(<span style=color:#000;font-weight:700>--</span><span style=color:#000;font-weight:700>color</span><span style=color:#000;font-weight:700>-</span>background<span style=color:#000;font-weight:700>-</span>secondary);
    <span style=color:#000;font-weight:700>font-size</span>: <span style=color:#099>70</span><span style=color:#458;font-weight:700>%</span>;
    <span style=color:#000;font-weight:700>padding-left</span>: <span style=color:#099>2</span><span style=color:#458;font-weight:700>px</span>;
    <span style=color:#000;font-weight:700>padding-right</span>: <span style=color:#099>2</span><span style=color:#458;font-weight:700>px</span>;
    <span style=color:#000;font-weight:700>border-radius</span>: <span style=color:#099>3</span><span style=color:#458;font-weight:700>px</span>;
    <span style=color:#000;font-weight:700>vertical-align</span>: <span style=color:#099>15</span><span style=color:#458;font-weight:700>%</span>;
    <span style=color:#000;font-weight:700>padding-bottom</span>: <span style=color:#099>2</span><span style=color:#458;font-weight:700>px</span>;
    <span style=color:#000;font-weight:700>filter</span>: <span style=color:#0086b3>opacity</span>(<span style=color:#099>40</span><span style=color:#458;font-weight:700>%</span>);
}
</code></pre></div><p>Note the use of CSS variables in order to support Furo&rsquo;s dynamic night mode feature.</p>
<p>Finally, we must tell Sphinx about this CSS file in the <code>conf.py</code> file:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>html_css_files <span style=color:#000;font-weight:700>=</span> [
    <span style=color:#d14>&#34;css/custom.css&#34;</span>,
]
</code></pre></div><h3 id=customising-the-table-appearance>Customising the table appearance<a hidden class=anchor aria-hidden=true href=#customising-the-table-appearance>#</a></h3>
<p>A similar CSS approach can be used to customise the appearance of the summary table itself. By adding the <code>:class:</code> option to the <code>list-table</code> directive, we can tell Sphinx to attach an HTML class to the <code>&lt;table></code> element, which we can then customise with CSS:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rst data-lang=rst>.. <span style=color:#000;font-weight:700>list-table</span>:: Title<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>   <span style=color:#458;font-weight:700>:header-rows:</span> <span style=color:#900;font-weight:700>0</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>   <span style=color:#458;font-weight:700>:widths:</span> <span style=color:#900;font-weight:700>auto</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>   <span style=color:#458;font-weight:700>:class:</span> <span style=color:#900;font-weight:700>summarytable</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>   
   <span style=color:#099>*</span> - ...<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>     <span style=color:#099>-</span> ...<span style=color:#a61717;background-color:#e3d2d2>
</span></code></pre></div><p>For my project, the only change I made to the default appearance is to force the table to span the entire width regardless of its contents. This can be done by adding the following code to our <code>custom.css</code> file:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-css data-lang=css><span style=color:navy>table</span>.<span style=color:#458;font-weight:700>summarytable</span> {
    <span style=color:#000;font-weight:700>width</span>: <span style=color:#099>100</span><span style=color:#458;font-weight:700>%</span>;
}
</code></pre></div><h3 id=putting-it-all-together>Putting it all together<a hidden class=anchor aria-hidden=true href=#putting-it-all-together>#</a></h3>
<p>We are now ready to put everything together and improve our <code>auto_summary()</code> macro to our liking. Here is the final code for <code>macros.rst</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jinja data-lang=jinja><span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>macro</span> <span style=color:teal>_render_item_name</span><span style=color:#000;font-weight:700>(</span><span style=color:teal>obj</span><span style=color:#000;font-weight:700>,</span> <span style=color:teal>sig</span><span style=color:#000;font-weight:700>=</span><span style=color:#000;font-weight:700>False</span><span style=color:#000;font-weight:700>)</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
:py:obj:`<span style=color:#999;font-weight:700;font-style:italic>{{</span> <span style=color:teal>obj.name</span> <span style=color:#999;font-weight:700;font-style:italic>}}</span> &lt;<span style=color:#999;font-weight:700;font-style:italic>{{</span> <span style=color:teal>obj.id</span> <span style=color:#999;font-weight:700;font-style:italic>}}</span>&gt;`
     <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>if</span> <span style=color:teal>sig</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
       \ (
       <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>for</span> <span style=color:teal>arg</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>obj.obj.args</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
          <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>if</span> <span style=color:teal>arg</span><span style=color:#000;font-weight:700>[</span><span style=color:#099>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#999;font-weight:700;font-style:italic>%}{{</span> <span style=color:teal>arg</span><span style=color:#000;font-weight:700>[</span><span style=color:#099>0</span><span style=color:#000;font-weight:700>]|</span><span style=color:#900;font-weight:700>replace</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;*&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#d14>&#39;\*&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#999;font-weight:700;font-style:italic>}}{%</span> <span style=color:#000;font-weight:700>endif</span> -<span style=color:#999;font-weight:700;font-style:italic>%}{{</span>  <span style=color:teal>arg</span><span style=color:#000;font-weight:700>[</span><span style=color:#099>1</span><span style=color:#000;font-weight:700>]</span> -<span style=color:#999;font-weight:700;font-style:italic>}}</span>
          <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>not</span> <span style=color:#0086b3>loop</span><span style=color:teal>.last</span>  <span style=color:#999;font-weight:700;font-style:italic>%}</span>, <span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endif</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
       <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>endfor</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
       )<span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>endif</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
<span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>endmacro</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>

<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>macro</span> <span style=color:teal>_item</span><span style=color:#000;font-weight:700>(</span><span style=color:teal>obj</span><span style=color:#000;font-weight:700>,</span> <span style=color:teal>sig</span><span style=color:#000;font-weight:700>=</span><span style=color:#000;font-weight:700>False</span><span style=color:#000;font-weight:700>,</span> <span style=color:teal>label</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#39;&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
   * - <span style=color:#999;font-weight:700;font-style:italic>{{</span> <span style=color:teal>_render_item_name</span><span style=color:#000;font-weight:700>(</span><span style=color:teal>obj</span><span style=color:#000;font-weight:700>,</span> <span style=color:teal>sig</span><span style=color:#000;font-weight:700>)</span> <span style=color:#999;font-weight:700;font-style:italic>}}</span>
     - <span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>if</span> <span style=color:teal>label</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>:summarylabel:`<span style=color:#999;font-weight:700;font-style:italic>{{</span> <span style=color:teal>label</span> <span style=color:#999;font-weight:700;font-style:italic>}}</span>` <span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endif</span> <span style=color:#999;font-weight:700;font-style:italic>%}{%</span> <span style=color:#000;font-weight:700>if</span> <span style=color:teal>obj.summary</span> <span style=color:#999;font-weight:700;font-style:italic>%}{{</span> <span style=color:teal>obj.summary</span> <span style=color:#999;font-weight:700;font-style:italic>}}{%</span> <span style=color:#000;font-weight:700>else</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>\-<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endif</span> <span style=color:#000;font-weight:700>+</span><span style=color:#999;font-weight:700;font-style:italic>%}</span>
<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endmacro</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>

<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>macro</span> <span style=color:teal>auto_summary</span><span style=color:#000;font-weight:700>(</span><span style=color:teal>objs</span><span style=color:#000;font-weight:700>,</span> <span style=color:teal>title</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#39;&#39;</span><span style=color:#000;font-weight:700>)</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
.. list-table:: <span style=color:#999;font-weight:700;font-style:italic>{{</span> <span style=color:teal>title</span> <span style=color:#999;font-weight:700;font-style:italic>}}</span>
   :header-rows: 0
   :widths: auto
   :class: summarytable

  <span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>for</span> <span style=color:teal>obj</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>objs</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
    <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>set</span> <span style=color:teal>sig</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span><span style=color:teal>obj.type</span> <span style=color:#000;font-weight:700>in</span> <span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;method&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#d14>&#39;function&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>and</span> <span style=color:#000;font-weight:700>not</span> <span style=color:#d14>&#39;property&#39;</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>obj.properties</span><span style=color:#000;font-weight:700>)</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>

    <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>if</span> <span style=color:#d14>&#39;property&#39;</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>obj.properties</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
      <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>set</span> <span style=color:teal>label</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;prop&#39;</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
    <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>elif</span> <span style=color:#d14>&#39;classmethod&#39;</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>obj.properties</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
      <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>set</span> <span style=color:teal>label</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;class&#39;</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
    <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>elif</span> <span style=color:#d14>&#39;abstractmethod&#39;</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>obj.properties</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
      <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>set</span> <span style=color:teal>label</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;abc&#39;</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
    <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>elif</span> <span style=color:#d14>&#39;staticmethod&#39;</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>obj.properties</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
      <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>set</span> <span style=color:teal>label</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;static&#39;</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
    <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>else</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
      <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>set</span> <span style=color:teal>label</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;&#39;</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>
    <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>endif</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>

    <span style=color:#999;font-weight:700;font-style:italic>{{</span><span style=color:#000;font-weight:700>-</span> <span style=color:teal>_item</span><span style=color:#000;font-weight:700>(</span><span style=color:teal>obj</span><span style=color:#000;font-weight:700>,</span> <span style=color:teal>sig</span><span style=color:#000;font-weight:700>=</span><span style=color:teal>sig</span><span style=color:#000;font-weight:700>,</span> <span style=color:teal>label</span><span style=color:#000;font-weight:700>=</span><span style=color:teal>label</span><span style=color:#000;font-weight:700>)</span> -<span style=color:#999;font-weight:700;font-style:italic>}}</span>
  <span style=color:#999;font-weight:700;font-style:italic>{%</span>- <span style=color:#000;font-weight:700>endfor</span> -<span style=color:#999;font-weight:700;font-style:italic>%}</span>

<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endmacro</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
</code></pre></div><p>The work is now split in three macros:</p>
<dl>
<dt><code>auto_summary()</code></dt>
<dd>This is the &ldquo;public&rdquo; macro. It generates a table based on a list of mapper objects, with an optional title. It iterates over the list of objects, and, for each of them, determines if the signature should be generated (functions and non-property methods) and if some label should be attached. It then uses <code>_item()</code> to generate each object&rsquo;s code.</dd>
<dt><code>_item()</code></dt>
<dd>This helper macro generates the code for each object, prepending a label to the summary if requested.</dd>
<dt><code>_render_item_name()</code></dt>
<dd>This helper macro focuses on generating the properly-cross-referenced object name. If the signature is requested, it iterates over the <code>obj.obj.args</code> list to produce a full (but unannotated) list of arguments.</dd>
</dl>
<h2 id=improving-the-default-templates>Improving the default templates<a hidden class=anchor aria-hidden=true href=#improving-the-default-templates>#</a></h2>
<p>With our <code>auto_summary()</code> macro completed, we are now ready to customise our templates, but we still have one issue to resolve before we do so.</p>
<h3 id=categorising-objects-with-a-custom-jinja2-test>Categorising objects with a custom Jinja2 test<a hidden class=anchor aria-hidden=true href=#categorising-objects-with-a-custom-jinja2-test>#</a></h3>
<p>As we saw in the <a href=#autoapi-objects>AutoAPI objects</a> section, mapper objects representing modules or classes have a <code>children</code> attribute which lists the objects it contains. For example, a module&rsquo;s <code>children</code> attribute lists all the classes, functions and attributes defined within it.</p>
<p>In order to categorise these children into separate sub-lists, the built-in templates heavily use the <a href=https://jinja.palletsprojects.com/en/3.1.x/templates/#jinja-filters.selectattr><code>selectattr()</code></a> and <a href=https://jinja.palletsprojects.com/en/3.1.x/templates/#jinja-filters.rejectattr><code>rejectattr()</code></a> filters. For example, a list of classes in a module can be obtained as follows:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jinja data-lang=jinja><span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>set</span> <span style=color:teal>visible_children</span> <span style=color:#000;font-weight:700>=</span>
    <span style=color:teal>module_object.children</span><span style=color:#000;font-weight:700>|</span><span style=color:#900;font-weight:700>selectattr</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;display&#34;</span><span style=color:#000;font-weight:700>)|</span><span style=color:#900;font-weight:700>rejectattr</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;imported&#34;</span><span style=color:#000;font-weight:700>)|</span><span style=color:#900;font-weight:700>list</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>set</span> <span style=color:teal>visible_classes</span> <span style=color:#000;font-weight:700>=</span>
    <span style=color:teal>visible_children</span><span style=color:#000;font-weight:700>|</span><span style=color:#900;font-weight:700>selectattr</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;type&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#d14>&#34;equalto&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#d14>&#34;class&#34;</span><span style=color:#000;font-weight:700>)|</span><span style=color:#900;font-weight:700>list</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
</code></pre></div><p>This code selects the visible (but not imported) children from <code>module_object</code>, and then further selects children which have their <code>type</code> set to <code>"class"</code>. In the code above, <a href=https://jinja.palletsprojects.com/en/3.1.x/templates/#jinja-tests.eq><code>"equalto"</code></a> is known as a Jinja <a href=https://jinja.palletsprojects.com/en/3.1.x/templates/#tests>test</a>. There are many such <a href=https://jinja.palletsprojects.com/en/3.1.x/templates/#builtin-tests>built-in tests</a> in Jinja2.</p>
<p>As stated before, we aim to categorise properties as attributes instead of methods. To that end, we will have to filter methods whose <code>properties</code> attribute contains <code>"property"</code>. Intuition dictates that the following code achieves this:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jinja data-lang=jinja><span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>set</span> <span style=color:teal>property_methods</span> <span style=color:#000;font-weight:700>=</span>
    <span style=color:teal>all_methods</span><span style=color:#000;font-weight:700>|</span><span style=color:#900;font-weight:700>selectattr</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;properties&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#d14>&#34;contains&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#d14>&#34;property&#34;</span><span style=color:#000;font-weight:700>)|</span><span style=color:#900;font-weight:700>list</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
</code></pre></div><p>The bad news is that no such <code>"contains"</code> test exists by default in Jinja2. The good news is that it is trivial to add one.</p>
<p>First, the actual test must be written. Add the following code to your <code>conf.py</code> file:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>contains</span>(seq, item):
    <span style=color:#000;font-weight:700>return</span> item <span style=color:#000;font-weight:700>in</span> seq
</code></pre></div><p>Then, we just need to add this test to the Jinja <a href=https://jinja.palletsprojects.com/en/3.1.x/api/#jinja2.Environment>environment</a>. Sphinx AutoAPI provides a hook for that:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>prepare_jinja_env</span>(jinja_env) <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>None</span>:
    jinja_env<span style=color:#000;font-weight:700>.</span>tests[<span style=color:#d14>&#34;contains&#34;</span>] <span style=color:#000;font-weight:700>=</span> contains

autoapi_prepare_jinja_env <span style=color:#000;font-weight:700>=</span> prepare_jinja_env
</code></pre></div><p>With this in your <code>conf.py</code> file, the template code above will work as expected.</p>
<h3 id=updating-templates>Updating templates<a hidden class=anchor aria-hidden=true href=#updating-templates>#</a></h3>
<p>We previously replaced one of <code>module.rst</code>&rsquo;s use of <code>autoapisummary</code> by our <code>auto_summary()</code> macro (see <a href=#basic-macro-setup>Basic macro setup</a>). It is now time to generalise the use of our macro. At this stage, the details of how this is done is to a large extent up to reader&rsquo;s taste. The <a href=https://github.com/abey79/vsketch/tree/master/docs/_templates/autoapi>templates</a> of <a href=https://github.com/abey79/vsketch>vsketch</a> can serve as fully-functional example and can readily be used in another projects.</p>
<p>For the <code>module.rst</code> template, I have opted to simplify the overview&rsquo;s structure by just generating tables (without headings) for classes, functions, and attributes:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jinja data-lang=jinja><span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>if</span> <span style=color:#d14>&#34;show-module-summary&#34;</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>autoapi_options</span> <span style=color:#000;font-weight:700>and</span> <span style=color:#000;font-weight:700>(</span><span style=color:teal>visible_classes</span> <span style=color:#000;font-weight:700>or</span> <span style=color:teal>visible_functions</span><span style=color:#000;font-weight:700>)</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>block</span> <span style=color:teal>classes</span> <span style=color:#000;font-weight:700>scoped</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>if</span> <span style=color:teal>visible_classes</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
<span style=color:#999;font-weight:700;font-style:italic>{{</span> <span style=color:teal>macros.auto_summary</span><span style=color:#000;font-weight:700>(</span><span style=color:teal>visible_classes</span><span style=color:#000;font-weight:700>,</span> <span style=color:teal>title</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;Classes&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#999;font-weight:700;font-style:italic>}}</span>
<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endif</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endblock</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>

<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>block</span> <span style=color:teal>functions</span> <span style=color:#000;font-weight:700>scoped</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>if</span> <span style=color:teal>visible_functions</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
<span style=color:#999;font-weight:700;font-style:italic>{{</span> <span style=color:teal>macros.auto_summary</span><span style=color:#000;font-weight:700>(</span><span style=color:teal>visible_functions</span><span style=color:#000;font-weight:700>,</span> <span style=color:teal>title</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;Functions&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#999;font-weight:700;font-style:italic>}}</span>
<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endif</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endblock</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>

<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>block</span> <span style=color:teal>attributes</span> <span style=color:#000;font-weight:700>scoped</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>if</span> <span style=color:teal>visible_attributes</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
<span style=color:#999;font-weight:700;font-style:italic>{{</span> <span style=color:teal>macros.auto_summary</span><span style=color:#000;font-weight:700>(</span><span style=color:teal>visible_attributes</span><span style=color:#000;font-weight:700>,</span> <span style=color:teal>title</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;Attributes&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#999;font-weight:700;font-style:italic>}}</span>
<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endif</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endblock</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
<span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endif</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
</code></pre></div><p>For the <code>class.rst</code> template, I chose to rework the structure of the documentation into two <a href=https://www.sphinx-doc.org/en/master/usage/restructuredtext/directives.html#directive-rubric>rubrics</a>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jinja data-lang=jinja>   <span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>if</span> <span style=color:teal>visible_methods</span> <span style=color:#000;font-weight:700>or</span> <span style=color:teal>visible_attributes</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
   .. rubric:: Overview

   <span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>set</span> <span style=color:teal>summary_methods</span> <span style=color:#000;font-weight:700>=</span> <span style=color:teal>visible_methods</span><span style=color:#000;font-weight:700>|</span><span style=color:#900;font-weight:700>rejectattr</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;properties&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#d14>&#34;contains&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#d14>&#34;property&#34;</span><span style=color:#000;font-weight:700>)|</span><span style=color:#900;font-weight:700>list</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
   <span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>set</span> <span style=color:teal>summary_attributes</span> <span style=color:#000;font-weight:700>=</span> <span style=color:teal>visible_attributes</span> <span style=color:#000;font-weight:700>+</span> <span style=color:teal>visible_methods</span><span style=color:#000;font-weight:700>|</span><span style=color:#900;font-weight:700>selectattr</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;properties&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#d14>&#34;contains&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#d14>&#34;property&#34;</span><span style=color:#000;font-weight:700>)|</span><span style=color:#900;font-weight:700>list</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
   
   <span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>if</span> <span style=color:teal>summary_attributes</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
   <span style=color:#999;font-weight:700;font-style:italic>{{</span> <span style=color:teal>macros.auto_summary</span><span style=color:#000;font-weight:700>(</span><span style=color:teal>summary_attributes</span><span style=color:#000;font-weight:700>,</span> <span style=color:teal>title</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;Attributes&#34;</span><span style=color:#000;font-weight:700>)|</span><span style=color:#900;font-weight:700>indent</span><span style=color:#000;font-weight:700>(</span><span style=color:#099>3</span><span style=color:#000;font-weight:700>)</span> <span style=color:#999;font-weight:700;font-style:italic>}}</span>
   <span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endif</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>

   <span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>if</span> <span style=color:teal>summary_methods</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
   <span style=color:#999;font-weight:700;font-style:italic>{{</span> <span style=color:teal>macros.auto_summary</span><span style=color:#000;font-weight:700>(</span><span style=color:teal>summary_methods</span><span style=color:#000;font-weight:700>,</span> <span style=color:teal>title</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;Methods&#34;</span><span style=color:#000;font-weight:700>)|</span><span style=color:#900;font-weight:700>indent</span><span style=color:#000;font-weight:700>(</span><span style=color:#099>3</span><span style=color:#000;font-weight:700>)</span> <span style=color:#999;font-weight:700;font-style:italic>}}</span>
   <span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endif</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>

   .. rubric:: Members

   <span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>for</span> <span style=color:teal>attribute</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>visible_attributes</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
   <span style=color:#999;font-weight:700;font-style:italic>{{</span> <span style=color:teal>attribute.render</span><span style=color:#000;font-weight:700>()|</span><span style=color:#900;font-weight:700>indent</span><span style=color:#000;font-weight:700>(</span><span style=color:#099>3</span><span style=color:#000;font-weight:700>)</span> <span style=color:#999;font-weight:700;font-style:italic>}}</span>
   <span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endfor</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
   <span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>for</span> <span style=color:teal>method</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>visible_methods</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
   <span style=color:#999;font-weight:700;font-style:italic>{{</span> <span style=color:teal>method.render</span><span style=color:#000;font-weight:700>()|</span><span style=color:#900;font-weight:700>indent</span><span style=color:#000;font-weight:700>(</span><span style=color:#099>3</span><span style=color:#000;font-weight:700>)</span> <span style=color:#999;font-weight:700;font-style:italic>}}</span>
   <span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endfor</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
   <span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>endif</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
</code></pre></div><p>Note the use of the custom <code>"contains"</code> Jinja2 test we implemented earlier.</p>
<h3 id=hiding-submodules>Hiding submodules<a hidden class=anchor aria-hidden=true href=#hiding-submodules>#</a></h3>
<p>Sphinx AutoAPI include all subpackages and submodules recursively, unless those are marked as private by prefixing their name with an underscore. In my packages' <code>__init__.py</code> file, I carefully import from submodules the objects which are meant to be public, but haven&rsquo;t necessarily marked the submodules as private. Sphinx AutoAPI has no option to control whether or not to add them (I <a href=https://github.com/readthedocs/sphinx-autoapi/issues/339>suggested</a> adding one), so I had to filter them out manually. This is done with the <code>autoapi-skip-member</code> event handler we mentioned earlier:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>skip_member</span>(app, what, name, obj, skip, options):
    <span style=color:#998;font-style:italic># skip submodules</span>
    <span style=color:#000;font-weight:700>if</span> what <span style=color:#000;font-weight:700>==</span> <span style=color:#d14>&#34;module&#34;</span>:
        skip <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>True</span>
    <span style=color:#000;font-weight:700>return</span> skip

<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>setup</span>(sphinx):
    sphinx<span style=color:#000;font-weight:700>.</span>connect(<span style=color:#d14>&#34;autoapi-skip-member&#34;</span>, skip_member)
</code></pre></div><h3 id=hiding-members>Hiding members<a hidden class=anchor aria-hidden=true href=#hiding-members>#</a></h3>
<p>Likewise, it may happen that you want to hide specific members from the documentation without marking them as private. Again, the <code>autoapi-skip-member</code> event handler can do that. The following example is based from <a href=https://github.com/abey79/vsketch/blob/0d937c851ac528bf182d0b71eb42ead525848c60/docs/conf.py#L116>actual code</a> in <a href=https://github.com/abey79/vsketch><em>vsketch</em></a>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>skip_member</span>(app, what, name, obj, skip, options):
    <span style=color:#000;font-weight:700>if</span> <span style=color:#d14>&#34;vsketch.SketchClass&#34;</span> <span style=color:#000;font-weight:700>in</span> name:
        <span style=color:#000;font-weight:700>if</span> obj<span style=color:#000;font-weight:700>.</span>name <span style=color:#000;font-weight:700>in</span> [
            <span style=color:#d14>&#34;vsk&#34;</span>,
            <span style=color:#d14>&#34;param_set&#34;</span>,
            <span style=color:#d14>&#34;execute_draw&#34;</span>,
            <span style=color:#d14>&#34;ensure_finalized&#34;</span>,
            <span style=color:#d14>&#34;execute&#34;</span>,
            <span style=color:#d14>&#34;get_params&#34;</span>,
            <span style=color:#d14>&#34;set_param_set&#34;</span>,
        ]:
            skip <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>True</span>
    <span style=color:#000;font-weight:700>return</span> skip
</code></pre></div><p>Note that <code>name</code> is the fully qualified name of the object, so the <code>vsk</code> member has <code>name</code> set to <code>vsketch.SketchClass.vsk</code>. In contrast, <code>obj.name</code> is just the base name.</p>
<p>Also, for this to work as expected for modules, I had to change the following line in <code>module.rst</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jinja data-lang=jinja><span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>set</span> <span style=color:teal>visible_children</span> <span style=color:#000;font-weight:700>=</span> <span style=color:teal>obj.children</span><span style=color:#000;font-weight:700>|</span><span style=color:#900;font-weight:700>selectattr</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;short_name&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#d14>&#34;in&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:teal>obj.all</span><span style=color:#000;font-weight:700>)|</span><span style=color:#900;font-weight:700>list</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
</code></pre></div><p>into</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jinja data-lang=jinja><span style=color:#999;font-weight:700;font-style:italic>{%</span> <span style=color:#000;font-weight:700>set</span> <span style=color:teal>visible_children</span> <span style=color:#000;font-weight:700>=</span> <span style=color:teal>obj.children</span><span style=color:#000;font-weight:700>|</span><span style=color:#900;font-weight:700>selectattr</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;display&#34;</span><span style=color:#000;font-weight:700>)|</span><span style=color:#900;font-weight:700>selectattr</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;short_name&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#d14>&#34;in&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:teal>obj.all</span><span style=color:#000;font-weight:700>)|</span><span style=color:#900;font-weight:700>list</span> <span style=color:#999;font-weight:700;font-style:italic>%}</span>
</code></pre></div><p>Without this modification, objects marked as skipped would show up in the summary tables.</p>
<h3 id=ordering>Ordering<a hidden class=anchor aria-hidden=true href=#ordering>#</a></h3>
<p>By default, Sphinx AutoAPI generates the documentation in the same order as the code. This can be <a href="https://sphinx-autoapi.readthedocs.io/en/latest/reference/config.html?highlight=ordering#confval-autoapi_member_order">changed</a> to alphabetical order, I like being in control from the code.</p>
<p>In <a href=https://github.com/abey79/vsketch><em>vsketch</em></a>, the top level content is determined by the imports in my package&rsquo;s <code>__init__.py</code> file, so the <code>import</code> statements themself matter. Since I&rsquo;m using <a href=https://pycqa.github.io/isort/>isort</a>, I had to short-circuit it in this particular case:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#998;font-style:italic># vsketch/__init__.py</span>

<span style=color:#998;font-style:italic># isort: skip_file</span>

<span style=color:#998;font-style:italic># Ordered for the documentation</span>
<span style=color:#000;font-weight:700>from</span> <span style=color:#555>.vsketch</span> <span style=color:#000;font-weight:700>import</span> Vsketch
<span style=color:#000;font-weight:700>from</span> <span style=color:#555>.shape</span> <span style=color:#000;font-weight:700>import</span> Shape
<span style=color:#000;font-weight:700>from</span> <span style=color:#555>.sketch_class</span> <span style=color:#000;font-weight:700>import</span> SketchClass, Param, ParamType

<span style=color:#000;font-weight:700>from</span> <span style=color:#555>.easing</span> <span style=color:#000;font-weight:700>import</span> EASING_FUNCTIONS
<span style=color:#000;font-weight:700>from</span> <span style=color:#555>.utils</span> <span style=color:#000;font-weight:700>import</span> working_directory
</code></pre></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2>
<p>Well, this ended up being much longer than anticipated üòÖ ‚Äì if you made it this far, congratulations! üéâ</p>
<p>Here is what we covered:</p>
<ul>
<li>We built on a basic Sphinx project and added AutoAPI to generate an API reference documentation.</li>
<li>We created custom templates based on the built-in templates provided by AutoAPI.</li>
<li>We reviewed the mapper objects created by AutoAPI to described our code.</li>
<li>We learned how to use a debugger to easily inspect these objects.</li>
<li>We crafted an <code>autosummary</code>-like macro named <code>auto_summary()</code> to build beautiful summary tables.</li>
<li>We customised these tables with custom CSS.</li>
<li>We used a custom Sphinx role and CSS to create tag-like labels to be used in the summary tables.</li>
<li>We learned of Jinja2&rsquo;s tests and created a custom one.</li>
<li>We controlled the visibility of submodules and members using a <code>autoapi-skip-member</code> event handler.</li>
<li>We learned how to control ordering from our code.</li>
</ul>
<p>Like any software project, improving the documentation is a never-ending endeavour. As it turns out, there is one remaining issue that has been bugging me and is yet unresolved. Due to a limitation in Sphinx, AutoAPI has a tendency to mangle the TOC ordering, especially when section headings are emitted from the templates. Check these <a href=https://github.com/readthedocs/sphinx-autoapi/issues/283>two</a> <a href=https://github.com/sphinx-doc/sphinx/issues/6316#issuecomment-1066195555>issues</a> for more information. Hopefully they&rsquo;ll get solved in the future.</p>
<p>I shall conclude by stating that, by all means, I do not consider myself a Sphinx expert ‚Äî much to the contrary. I <em>did</em> spend a lot of time improving my API documentation, and figured it would be wasteful not to share my findings, especially given the relative scarcity of information on advanced Sphinx usage patterns. As a result, it is rather likely that I made mistakes and sub-optimal choices. If so, please do provide feedback, and I&rsquo;ll update this article to improve it.</p>
<p><em>Edit: updated title and intro to clarify the nature of the API discussed, i.e. Python API (2022-05-11).</em></p>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>Ideally, these shortcomings would be addressed using an extension and a custom directive, or even by contributing the improvement back to the Sphinx or AutoAPI projects. This is sadly beyond my skills. Also, the template method is anyway useful for highly specific requirements where writing an extension wouldn&rsquo;t be warranted.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</section>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://bylr.info/tags/python/>python</a></li>
<li><a href=https://bylr.info/tags/sphinx/>sphinx</a></li>
</ul>
</footer><script src=https://utteranc.es/client.js repo=abey79/abey79.github.io issue-term=pathname label=comments theme=github-light crossorigin=anonymous async></script>
</article>
</main>
<footer class=footer>
<span>¬© 2022 Antoine Beyeler ‚Äì</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>