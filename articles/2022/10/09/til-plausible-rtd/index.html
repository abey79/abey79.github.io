<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>TIL: use Plausible.io with a Sphinx documentation hosted on RTD | bylr.info</title>
<meta name=keywords content="python,sphinx,til">
<meta name=description content="Although Google Analytics is very easy to setup on a Read the Docs-based documentation website, it requires a cookie banner to be GDPR-compliant and is otherwise questionable from a privacy-preservation point-of-view. As a result, I much prefer to use and support the excellent EU-based Plausible.io for traffic metrics instead.
This article explains how to setup a Read the Docs-based documentation with Plausible.io such that metrics are enabled only on &ldquo;production&rdquo; builds — e.">
<meta name=author content>
<link rel=canonical href=https://bylr.info/articles/2022/10/09/til-plausible-rtd/>
<link crossorigin=anonymous href=/assets/css/stylesheet.6c6bbb0265bd99a430fed22493ed8a614c025b8b6da7f1f7b07910f023f53da8.css integrity="sha256-bGu7AmW9maQw/tIkk+2KYUwCW4ttp/H3sHkQ8CP1Pag=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://bylr.info/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://bylr.info/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://bylr.info/favicon-32x32.png>
<link rel=apple-touch-icon href=https://bylr.info/apple-touch-icon.png>
<link rel=mask-icon href=https://bylr.info/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
</noscript><script defer data-domain=bylr.info data-api=https://sta.abeyeler.workers.dev/sta/event src=https://sta.abeyeler.workers.dev/sta/script.js></script><meta property="og:title" content="TIL: use Plausible.io with a Sphinx documentation hosted on RTD">
<meta property="og:description" content="Although Google Analytics is very easy to setup on a Read the Docs-based documentation website, it requires a cookie banner to be GDPR-compliant and is otherwise questionable from a privacy-preservation point-of-view. As a result, I much prefer to use and support the excellent EU-based Plausible.io for traffic metrics instead.
This article explains how to setup a Read the Docs-based documentation with Plausible.io such that metrics are enabled only on &ldquo;production&rdquo; builds — e.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://bylr.info/articles/2022/10/09/til-plausible-rtd/"><meta property="og:image" content="https://bylr.info/android-chrome-512x512.png"><meta property="article:section" content="articles">
<meta property="article:published_time" content="2022-10-09T00:00:00+00:00">
<meta property="article:modified_time" content="2022-10-09T00:00:00+00:00"><meta property="og:site_name" content="Antoine Beyeler">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://bylr.info/android-chrome-512x512.png">
<meta name=twitter:title content="TIL: use Plausible.io with a Sphinx documentation hosted on RTD">
<meta name=twitter:description content="Although Google Analytics is very easy to setup on a Read the Docs-based documentation website, it requires a cookie banner to be GDPR-compliant and is otherwise questionable from a privacy-preservation point-of-view. As a result, I much prefer to use and support the excellent EU-based Plausible.io for traffic metrics instead.
This article explains how to setup a Read the Docs-based documentation with Plausible.io such that metrics are enabled only on &ldquo;production&rdquo; builds — e.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Articles","item":"https://bylr.info/articles/"},{"@type":"ListItem","position":2,"name":"TIL: use Plausible.io with a Sphinx documentation hosted on RTD","item":"https://bylr.info/articles/2022/10/09/til-plausible-rtd/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"TIL: use Plausible.io with a Sphinx documentation hosted on RTD","name":"TIL: use Plausible.io with a Sphinx documentation hosted on RTD","description":"Although Google Analytics is very easy to setup on a Read the Docs-based documentation website, it requires a cookie banner to be GDPR-compliant and is otherwise questionable from a privacy-preservation point-of-view. As a result, I much prefer to use and support the excellent EU-based Plausible.io for traffic metrics instead.\nThis article explains how to setup a Read the Docs-based documentation with Plausible.io such that metrics are enabled only on \u0026ldquo;production\u0026rdquo; builds — e.","keywords":["python","sphinx","til"],"articleBody":"Although Google Analytics is very easy to setup on a Read the Docs-based documentation website, it requires a cookie banner to be GDPR-compliant and is otherwise questionable from a privacy-preservation point-of-view. As a result, I much prefer to use and support the excellent EU-based Plausible.io for traffic metrics instead.\nThis article explains how to setup a Read the Docs-based documentation with Plausible.io such that metrics are enabled only on “production” builds — e.g. the “latest” builds from the main branch and the version-tagged builds. This minimises the contamination of traffic statistics by development-related activities.\nTo achieve this, the basic idea is to customise your Sphinx template such that the Plausible.io script is only included when a conf.py-defined flag is set to True. This flag is then set based on environment variables provided by Read the Docs.\nLet’s dive in the details a step at a time.\nEnabling templates If you haven’t done so already (for example to customise your API documentation), create a _templates sub-directory and let Sphinx know that this is where custom templates are to be found:\n# conf.py templates_path = [\"_templates\"] Customising the template Then, a custom template can be created to include the Plausible.io script. Create a _templates/base.html file with the following content:\n {% extends \"!base.html\" %} {% block extrahead %} {% if enable_plausible %} script defer data-domain=\"myproject.readthedocs.io\" src=\"https://plausible.io/js/script.js\"script {% endif %} {{ super() }} {% endblock %} In _templates/base.html, replace myproject.readthedocs.io by the actual domain name of your documentation. This domain name must also be enabled in your Plausible.io account.\nNote that the  tag is added only if the template variable enable_plausible evaluates to True. This is how we can control whether or not metrics should be enabled for a given build.\nImportant: I’m using the Furo theme, which uses base.html as main HTML file. Other themes (including the default Sphinx theme) might be using layout.html instead, as indicated in Sphinx’s documentation on templating. This initially threw me off, so make sure to check which of your template’s file must be extended.\nEnabling metrics on production build The enable_plausible variable must be defined for our template above to function. This is done in conf.py file using the html_context variable as follows:\n# conf.py import os # [...] READTHEDOCS_VERSION_TYPE = os.environ.get(\"READTHEDOCS_VERSION_TYPE\", None) html_context = { \"enable_plausible\": READTHEDOCS_VERSION_TYPE in [\"branch\", \"tag\"], } I use the READTHEDOCS_VERSION_TYPE environment variable, which is set by Read the Docs. Its value is \"branch\" when the docs are built from the main branch, and \"tag\" when they are built from a tagged release. We want enable_plausible to be set to True in those instances. In any other case, including when READTHEDOCS_VERSION_TYPE is undefined (as is the case for local builds), enable_plausible is set to False.\nAnd that’s about it – these few steps are all it takes more compliant and privacy-friendly metrics thanks to Plausible.io. For a real-world example, you can check my vpype project (relevant PR).\n","wordCount":"489","inLanguage":"en","datePublished":"2022-10-09T00:00:00Z","dateModified":"2022-10-09T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://bylr.info/articles/2022/10/09/til-plausible-rtd/"},"publisher":{"@type":"Organization","name":"bylr.info","logo":{"@type":"ImageObject","url":"https://bylr.info/favicon.ico"}}}</script>
</head>
<body id=top>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://bylr.info/ accesskey=h title="bylr.info (Alt + H)">bylr.info</a>
<div class=logo-switches>
</div>
</div>
<ul id=menu>
<li>
<a href=https://bylr.info/about/ title=about>
<span>about</span>
</a>
</li>
<li>
<a href=https://bylr.info/archives title=archives>
<span>archives</span>
</a>
</li>
<li>
<a href=https://bylr.info/tags/ title=tags>
<span>tags</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
TIL: use Plausible.io with a Sphinx documentation hosted on RTD
</h1>
<div class=post-meta><span title="2022-10-09 00:00:00 +0000 UTC">October 9, 2022</span>&nbsp;|&nbsp;<a href=https://github.com/abey79/abey79.github.io/blob/main/content/articles/til-plausible-rtd.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header>
<div class=post-content><p>Although Google Analytics is very easy to setup on a <a href=https://readthedocs.org><em>Read the Docs</em></a>-based documentation website, it requires a cookie banner to be <a href=https://en.wikipedia.org/wiki/General_Data_Protection_Regulation>GDPR</a>-compliant and is otherwise questionable from a privacy-preservation point-of-view. As a result, I much prefer to use and support the excellent EU-based <a href=https://plausible.io/>Plausible.io</a> for traffic metrics instead.</p>
<p>This article explains how to setup a <em>Read the Docs</em>-based documentation with Plausible.io such that metrics are enabled only on &ldquo;production&rdquo; builds — e.g. the &ldquo;latest&rdquo; builds from the main branch and the version-tagged builds. This minimises the contamination of traffic statistics by development-related activities.</p>
<p>To achieve this, the basic idea is to customise your Sphinx template such that the <a href=https://plausible.io/docs/plausible-script>Plausible.io script</a> is only included when a <code>conf.py</code>-defined flag is set to <code>True</code>. This flag is then set based on <a href=https://docs.readthedocs.io/en/stable/environment-variables.html>environment variables provided by <em>Read the Docs</em></a>.</p>
<p>Let&rsquo;s dive in the details a step at a time.</p>
<h2 id=enabling-templates>Enabling templates<a hidden class=anchor aria-hidden=true href=#enabling-templates>#</a></h2>
<p>If you haven&rsquo;t done so already (for example to <a href=https://bylr.info/articles/2022/05/10/api-doc-with-sphinx-autoapi/>customise your API documentation</a>), create a <code>_templates</code> sub-directory and let Sphinx know that this is where custom templates are to be found:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#998;font-style:italic># conf.py</span>

templates_path <span style=color:#000;font-weight:700>=</span> [<span style=color:#d14>&#34;_templates&#34;</span>]
</code></pre></div><h2 id=customising-the-template>Customising the template<a hidden class=anchor aria-hidden=true href=#customising-the-template>#</a></h2>
<p>Then, a custom template can be created to include the Plausible.io script. Create a <code>_templates/base.html</code> file with the following content:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=color:#998;font-style:italic>&lt;!-- _templates/base.html --&gt;</span>
{% extends &#34;!base.html&#34; %}
{% block extrahead %}
    {% if enable_plausible %}
        &lt;<span style=color:navy>script</span> <span style=color:teal>defer</span> <span style=color:teal>data-domain</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;myproject.readthedocs.io&#34;</span>
                <span style=color:teal>src</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;https://plausible.io/js/script.js&#34;</span>&gt;&lt;/<span style=color:navy>script</span>&gt;
    {% endif %}
    {{ super() }}
{% endblock %}
</code></pre></div><p>In <code>_templates/base.html</code>, replace <code>myproject.readthedocs.io</code> by the actual domain name of your documentation. This domain name must also be enabled in your Plausible.io account.</p>
<p>Note that the <code>&lt;script></code> tag is added <em>only</em> if the template variable <code>enable_plausible</code> evaluates to <code>True</code>. This is how we can control whether or not metrics should be enabled for a given build.</p>
<p><strong>Important</strong>: I&rsquo;m using the <a href=https://pradyunsg.me/furo/quickstart/>Furo</a> theme, which uses <code>base.html</code> as main HTML file. Other themes (including the default Sphinx theme) might be using <code>layout.html</code> instead, as indicated in <a href=https://www.sphinx-doc.org/en/master/templating.html>Sphinx&rsquo;s documentation</a> on templating. This initially threw me off, so make sure to check which of your template&rsquo;s file must be extended.</p>
<h2 id=enabling-metrics-on-production-build>Enabling metrics on production build<a hidden class=anchor aria-hidden=true href=#enabling-metrics-on-production-build>#</a></h2>
<p>The <code>enable_plausible</code> variable must be defined for our template above to function. This is done in <code>conf.py</code> file using the <code>html_context</code> variable as follows:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#998;font-style:italic># conf.py</span>
<span style=color:#000;font-weight:700>import</span> <span style=color:#555>os</span>

<span style=color:#998;font-style:italic># [...]</span>

READTHEDOCS_VERSION_TYPE <span style=color:#000;font-weight:700>=</span> os<span style=color:#000;font-weight:700>.</span>environ<span style=color:#000;font-weight:700>.</span>get(<span style=color:#d14>&#34;READTHEDOCS_VERSION_TYPE&#34;</span>, <span style=color:#000;font-weight:700>None</span>)

html_context <span style=color:#000;font-weight:700>=</span> {
    <span style=color:#d14>&#34;enable_plausible&#34;</span>: READTHEDOCS_VERSION_TYPE <span style=color:#000;font-weight:700>in</span> [<span style=color:#d14>&#34;branch&#34;</span>, <span style=color:#d14>&#34;tag&#34;</span>],
}
</code></pre></div><p>I use the <code>READTHEDOCS_VERSION_TYPE</code> environment variable, which is <a href=https://docs.readthedocs.io/en/stable/environment-variables.html#envvar-READTHEDOCS_VERSION_TYPE>set by <em>Read the Docs</em></a>. Its value is <code>"branch"</code> when the docs are built from the main branch, and <code>"tag"</code> when they are built from a tagged release. We want <code>enable_plausible</code> to be set to <code>True</code> in those instances. In any other case, including when <code>READTHEDOCS_VERSION_TYPE</code> is undefined (as is the case for local builds), <code>enable_plausible</code> is set to <code>False</code>.</p>
<p>And that&rsquo;s about it – these few steps are all it takes more compliant and privacy-friendly metrics thanks to <code>Plausible.io</code>. For a real-world example, you can check my <a href=https://vpype.readthedocs.io/en/latest/><em>vpype</em></a> project (<a href=https://github.com/abey79/vpype/pull/546/files>relevant PR</a>).</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://bylr.info/tags/python/>python</a></li>
<li><a href=https://bylr.info/tags/sphinx/>sphinx</a></li>
<li><a href=https://bylr.info/tags/til/>til</a></li>
</ul>
</footer><script src=https://utteranc.es/client.js repo=abey79/abey79.github.io issue-term=pathname label=comments theme=github-light crossorigin=anonymous async></script>
</article>
</main>
<footer class=footer>
<span>© 2022-2023 Antoine Beyeler –</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='copy';function d(){a.innerHTML='copied!',setTimeout(()=>{a.innerHTML='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>